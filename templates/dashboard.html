<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet James - PPC Performance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jQuery instead of Alpine.js -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Core styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Dark mode */
        body.dark-mode {
            background-color: #111827;
            color: #f3f4f6;
        }
        
        /* Sidebar styles - FIXED visibility */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }
        
        body.dark-mode .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }
        
        /* Main content */
        .main-content {
            margin-left: 280px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* Card styles */
        .card {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .card {
            background: #1f2937;
        }
        
        /* Metric card */
        .metric-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .metric-card {
            background: #1f2937;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        body.dark-mode .metric-label {
            color: #9ca3af;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
        }
        
        body.dark-mode .metric-value {
            color: #f3f4f6;
        }
        
        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            transition: all 0.2s;
        }
        
        body.dark-mode .btn-secondary {
            background: #374151;
            color: #f3f4f6;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        body.dark-mode .btn-secondary:hover {
            background: #4b5563;
        }
        
        /* Date button */
        .date-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: #f3f4f6;
            color: #374151;
            transition: all 0.2s;
        }
        
        .date-btn:hover {
            background: #e5e7eb;
        }
        
        .date-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        body.dark-mode .date-btn {
            background: #374151;
            color: #f3f4f6;
        }
        
        body.dark-mode .date-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Table styles */
        .table-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        body.dark-mode .table-header {
            background: #111827;
            border-bottom-color: #374151;
        }
        
        .table-row {
            border-bottom: 1px solid #e5e7eb;
        }
        
        body.dark-mode .table-row {
            border-bottom-color: #374151;
        }
        
        /* Alternating row colors */
        .table-row:nth-child(even) {
            background: #f9fafb;
        }
        
        body.dark-mode .table-row:nth-child(even) {
            background: #1a202c;
        }
        
        .table-row:hover {
            background: #ede9fe !important;
        }
        
        body.dark-mode .table-row:hover {
            background: #2d3748 !important;
        }
        
        .table-cell {
            padding: 0.75rem;
            font-size: 0.875rem;
        }
        
        /* Group header styles */
        .group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        body.dark-mode .group-header {
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%);
        }
        
        /* State filter buttons */
        .state-filter-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            background: #e5e7eb;
            color: #374151;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .state-filter-btn:hover {
            background: #d1d5db;
        }
        
        .state-filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        body.dark-mode .state-filter-btn {
            background: #374151;
            color: #f3f4f6;
        }
        
        body.dark-mode .state-filter-btn:hover {
            background: #4b5563;
        }
        
        body.dark-mode .state-filter-btn.active {
            background: #667eea;
            border-color: #667eea;
        }
        
        /* Client link styles */
        .client-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .client-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        body.dark-mode .client-link {
            color: #818cf8;
        }
        
        body.dark-mode .client-link:hover {
            color: #a78bfa;
        }
        
        /* Navigation links */
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .nav-link:hover {
            background: #f3f4f6;
            color: #111827;
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        body.dark-mode .nav-link {
            color: #d1d5db;
        }
        
        body.dark-mode .nav-link:hover {
            background: #374151;
            color: #f3f4f6;
        }
        
        body.dark-mode .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    
        .new-lead-row {
            background-color: #e7f3ff !important;  /* Light blue for new leads */
        }

        .conversion-row {
            background-color: #e7ffe7 !important;  /* Light green for conversions */
        }

        .table tbody tr:hover {
            opacity: 0.95;
        }
        
        /* Loader */
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status dot */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        /* Sidebar toggle - FIXED positioning */
        .sidebar-toggle {
            position: fixed;
            left: 260px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: left 0.3s ease;
        }
        
        .sidebar.collapsed ~ .sidebar-toggle {
            left: -16px;
        }
        
        body.dark-mode .sidebar-toggle {
            background: #1f2937;
            border-color: #374151;
        }
        
        /* Exclusion filters */
        .exclusion-filters {
            background: #fef3c7;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #fbbf24;
        }
        
        body.dark-mode .exclusion-filters {
            background: #78350f;
            border-color: #92400e;
        }
        
        .text-warning {
            color: #f59e0b;
        }
        
        /* Text colors matching theme */
        .text-green-600 { color: #10b981; }
        .text-blue-600 { color: #3b82f6; }
        .text-purple-600 { color: #8b5cf6; }
        .text-yellow-600 { color: #f59e0b; }
        .text-red-600 { color: #ef4444; }
        .text-gray-500 { color: #6b7280; }
        
        /* Special row for Crisp/YouTube */
        .youtube-row {
            background: linear-gradient(135deg, #fee2e2 0%, #fef3c7 100%);
            font-style: italic;
        }
        
        body.dark-mode .youtube-row {
            background: linear-gradient(135deg, #7f1d1d 0%, #78350f 100%);
        }

        /* Modal animation styles */
        #customDateModal {
            transition: opacity 300ms ease-in-out;
        }

        /* Date input styling for better browser compatibility */
        input[type="date"] {
            position: relative;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 10px;
            opacity: 0.6;
            cursor: pointer;
        }

        body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Quick range button hover effects */
        .quick-range-btn {
            transition: all 0.2s ease;
        }

        .quick-range-btn:hover {
            transform: translateY(-1px);
        }

        .quick-range-btn:active {
            transform: translateY(0);
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .hide-mobile {
                display: none !important;
            }
            
            .show-mobile {
                display: flex !important;
            }
            
            .sidebar {
                position: fixed;
                z-index: 50;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                left: 264px;
            }
            
            .sidebar.collapsed ~ .sidebar-toggle {
                left: -16px;
            }
        }
        
        @media (min-width: 769px) {
            .show-mobile {
                display: none !important;
            }
        }
        
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 z-40">
        <div class="p-6 border-b border-gray-200 dark-mode:border-gray-700">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-lg flex items-center justify-center">
                    <span class="font-bold text-white text-sm">SJ</span>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 dark-mode:text-white">Sweet James</h1>
                    <p class="text-xs text-gray-500 dark-mode:text-gray-300">Analytics Suite</p>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Content -->
        <div class="p-6 space-y-6">
            
            <!-- Navigation Section -->
            <div>
                <h3 class="text-xs font-medium text-gray-500 dark-mode:text-gray-400 uppercase tracking-wider mb-3">Dashboards</h3>
                <nav class="space-y-1">
                    <a href="/" class="nav-link active">
                        <i class="fas fa-chart-line mr-3 w-4"></i>
                        <span>Daily PPC Dashboard</span>
                    </a>
                    <!-- <a href="/forecasting" class="nav-link">
                        <i class="fas fa-chart-bar mr-3 w-4"></i>
                        <span>Forecasting</span>
                    </a>
                    <a href="/comparison-dashboard" class="nav-link">
                        <i class="fas fa-balance-scale mr-3 w-4"></i>
                        <span>Period Comparison</span>
                    </a> -->
                    <a href="/current-month-performance" class="nav-link">
                        <i class="fas fa-calendar-day mr-3 w-4"></i>
                        <span>Current Month</span>
                    </a>
                    <a href="/annual-analytics" class="nav-link">
                        <i class="fas fa-calendar mr-3 w-4"></i>
                        <span>Annual Analytics</span>
                    </a>
                </nav>
            </div>
            
            <!-- Configuration Section -->
            <div>
                <h3 class="text-xs font-medium text-gray-500 dark-mode:text-gray-400 uppercase tracking-wider mb-3">Configuration</h3>
                <nav class="space-y-1">
                    <a href="/campaign-mapping" class="nav-link">
                        <i class="fas fa-sitemap mr-3 w-4"></i>
                        <span>Campaign Mapping</span>
                    </a>
                </nav>
            </div>
            
            <!-- Lead Filters Section -->
            
            <!-- <div>
                <h3 class="text-xs font-medium text-gray-500 dark-mode:text-gray-400 uppercase tracking-wider mb-3">Lead Filters</h3>
                
                <div class="space-y-2">
                    <h4 class="text-xs text-gray-600 dark-mode:text-gray-300 font-medium mb-2">Include Excluded Types:</h4>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="includeSpam" class="form-checkbox rounded">
                        <span class="text-sm text-gray-700 dark-mode:text-gray-300">Include Spam (<span id="spamCount">0</span>)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="includeAbandoned" class="form-checkbox rounded">
                        <span class="text-sm text-gray-700 dark-mode:text-gray-300">Include Abandoned (<span id="abandonedCount">0</span>)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="includeDuplicate" class="form-checkbox rounded">
                        <span class="text-sm text-gray-700 dark-mode:text-gray-300">Include Duplicate (<span id="duplicateCount">0</span>)</span>
                    </label>
                </div>
            </div> -->
            
            <!-- Display Settings Section - NEW -->
            <div>
                <h3 class="text-xs font-medium text-gray-500 dark-mode:text-gray-400 uppercase tracking-wider mb-3">Display Settings</h3>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="disableColorCoding" class="form-checkbox rounded">
                    <span class="text-sm text-gray-700 dark-mode:text-gray-300">Disable KPI Color Coding</span>
                </label>
            </div>
            
            <!-- Dark Mode Toggle -->
            <div class="pt-4 border-t border-gray-200 dark-mode:border-gray-700">
                <button id="darkModeToggle" class="w-full btn-secondary px-4 py-2 rounded-md text-sm">
                    <i id="darkModeIcon" class="fas fa-moon mr-2"></i>
                    <span id="darkModeText">Dark Mode</span>
                </button>
            </div>
        </div>
    </aside>
    
    <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <i id="sidebarIcon" class="fas fa-chevron-left text-gray-500 text-sm"></i>
    </div>
    
    <!-- Main Content -->
    <main id="mainContent" class="main-content">
        <!-- Enhanced Top Bar with Controls -->
        <header class="card border-b sticky top-0 z-30">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Left side - Title -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 dark-mode:text-white">Performance Dashboard</h2>
                        <p class="text-sm text-gray-500 dark-mode:text-gray-400 mt-1">
                            <strong>Showing Data For:</strong> <span id="dateRangeText"></span>
                            <span id="filterText"></span>
                            <span id="exclusionText" class="text-warning" style="display: none;">
                                • Including: <span id="exclusionList"></span>
                            </span>
                            <span id="colorCodingStatus" class="ml-2" style="display: none;">
                                • <i class="fas fa-eye-slash text-gray-500"></i> Color coding disabled
                            </span>
                        </p>
                    </div>
                    
                    <!-- Right side - Controls -->
                    <div class="flex items-center space-x-3">
                        <!-- API Status -->
                        <div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between p-3 card rounded-md">
                                    <span class="text-sm text-gray-700 dark-mode:text-gray-200">Google Ads</span>
                                    &nbsp; <div id="googleAdsStatus" class="status-dot bg-amber-500"></div>&nbsp; 
                                    &nbsp; <span class="text-sm text-gray-700 dark-mode:text-gray-200">Litify</span>&nbsp;
                                    <div id="litifyStatus" class="status-dot bg-amber-500"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date Range Buttons -->
                        <div class="flex items-center space-x-1 hide-mobile">
                            <button data-range="today" class="date-btn">Today</button>
                            <button data-range="yesterday" class="date-btn">Yesterday</button>
                            <button data-range="week" class="date-btn">7 Days</button>
                            <button data-range="month" class="date-btn">30 Days</button>
                            <button data-range="custom" class="date-btn">Custom</button>
                        </div>
                        
                        <!-- Refresh Button -->
                        <button id="refreshBtn" class="btn-primary px-4 py-2 rounded-md text-sm">
                            <i id="refreshIcon" class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Date Range -->
                <div class="mobile-date-range mt-3 flex items-center space-x-2 show-mobile">
                    <button data-range="today" class="date-btn flex-1">Today</button>
                    <button data-range="week" class="date-btn flex-1">Week</button>
                    <button data-range="month" class="date-btn flex-1">Month</button>
                </div>
                
                <!-- Exclusion Filter Alert Bar -->
                <div id="exclusionAlert" class="exclusion-filters mt-3" style="display: none;">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-info-circle text-warning"></i>
                            <span class="text-sm text-gray-700 dark-mode:text-gray-300">
                                Currently including <span id="includedCount" class="font-semibold">0</span> 
                                additional leads from excluded case types
                            </span>
                        </div>
                        <button id="clearExclusionBtn" class="text-sm text-warning hover:underline">
                            Clear filters
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="p-6">
            <!-- Loading State -->
            <div id="loadingState" class="flex justify-center items-center py-20" style="display: none;">
                <div class="text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-lg font-medium text-gray-900 dark-mode:text-white">Loading dashboard data...</p>
                    <p class="text-sm text-gray-500 dark-mode:text-gray-400 mt-2">Fetching from Google Ads and Litify...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="card rounded-lg p-8 text-center" style="display: none;">
                <i class="fas fa-exclamation-circle text-5xl text-red-500 mb-4"></i>
                <h2 class="text-xl font-bold text-gray-900 dark-mode:text-white mb-2">Connection Error</h2>
                <p id="errorMessage" class="text-gray-500 dark-mode:text-gray-400 mb-4"></p>
                <button id="retryBtn" class="btn-primary px-6 py-2 rounded-md">
                    <i class="fas fa-redo mr-2"></i>
                    Retry Connection
                </button>
            </div>

            <!-- Main Dashboard Content -->
            <div id="dashboardContent">
                <!-- Summary Cards (excluding Crisp/YouTube) -->
                <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6">
                    <!-- Cards will be dynamically inserted here -->
                </div>

                <!-- Campaign Performance Table -->
                <div class="card rounded-lg mb-6">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark-mode:text-white">Campaign Performance by Bucket</h3>
                                <p class="text-xs text-gray-500 dark-mode:text-gray-400 mt-1">*Crisp/YouTube tracked separately below</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- State Filters -->
                                <div class="flex items-center space-x-1">
                                    <button data-state="all" class="state-filter-btn active">All States</button>
                                    <button data-state="CA" class="state-filter-btn">CA</button>
                                    <button data-state="AZ" class="state-filter-btn">AZ</button>
                                    <button data-state="GA" class="state-filter-btn">GA</button>
                                    <button data-state="TX" class="state-filter-btn">TX</button>
                                </div>
                                
                                <button id="exportBtn" class="btn-secondary px-3 py-1 rounded-md text-sm">
                                    <i class="fas fa-download mr-1"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="table-header">
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Litify Leads Detail -->
                <div id="litifySection" class="card rounded-lg mb-6">
                    <div class="p-6">
                        <div class="border-b pb-4 mb-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark-mode:text-white">Litify Leads Detail</h3>
                                    <p class="text-sm text-gray-500 dark-mode:text-gray-400 mt-1">
                                        <span id="litifyLeadsCount" class="font-medium text-gray-700 dark-mode:text-gray-300">0</span> leads
                                        <span id="litifyBucketText"></span>
                                    </p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <select id="litifyBucketFilter" class="form-input px-3 py-2 rounded-md text-sm border border-gray-300 dark-mode:border-gray-600">
                                        <option value="all">All Buckets</option>
                                    </select>
                                    
                                    <button id="litifyToggle" class="btn-secondary px-3 py-2 rounded-md text-sm">
                                        <i id="litifyToggleIcon" class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="litifyDetail" class="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table class="w-full">
                                <thead class="table-header sticky top-0 z-10">
                                    <tr id="litifyTableHeader"></tr>
                                </thead>
                                <tbody id="litifyTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Performance Trend Chart -->
                    <div class="card rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark-mode:text-white mb-4">
                            Performance Trend
                            <span class="text-xs font-normal text-gray-500 dark-mode:text-gray-400">(Excludes YouTube)</span>
                        </h3>
                        <div class="h-64">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Cost Breakdown Chart -->
                    <div class="card rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark-mode:text-white mb-4">
                            Cost Breakdown
                            <span class="text-xs font-normal text-gray-500 dark-mode:text-gray-400">(Excludes YouTube)</span>
                        </h3>
                        <div class="h-64">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>

                    <!-- Key Insights -->
                    <div class="card rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark-mode:text-white mb-4">
                            Key Insights
                            <span class="text-xs font-normal text-gray-500 dark-mode:text-gray-400">(Excludes YouTube)</span>
                        </h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark-mode:bg-gray-700 rounded-md">
                                <span class="text-sm text-gray-600 dark-mode:text-gray-400">Best Conversion</span>
                                <span id="bestConversion" class="font-semibold text-green-600 dark-mode:text-green-400"></span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark-mode:bg-gray-700 rounded-md">
                                <span class="text-sm text-gray-600 dark-mode:text-gray-400">Lowest CPL</span>
                                <span id="lowestCPL" class="font-semibold text-blue-600 dark-mode:text-blue-400"></span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark-mode:bg-gray-700 rounded-md">
                                <span class="text-sm text-gray-600 dark-mode:text-gray-400">Highest Volume</span>
                                <span id="highestVolume" class="font-semibold text-purple-600 dark-mode:text-purple-400"></span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark-mode:bg-gray-700 rounded-md">
                                <span class="text-sm text-gray-600 dark-mode:text-gray-400">Most Efficient CPA</span>
                                <span id="mostEfficient" class="font-semibold text-gray-700 dark-mode:text-gray-300"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <!-- Custom Date Range Modal -->
    <div id="customDateModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Select Date Range</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Choose a custom date range for your dashboard</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
                        <input type="date" id="customStartDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date</label>
                        <input type="date" id="customEndDate" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- Quick Range Buttons -->
                    <div class="pt-2 border-t border-gray-200 dark:border-gray-700">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Quick Ranges</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="quick-range-btn text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600" data-days="7">Last 7 days</button>
                            <button class="quick-range-btn text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600" data-days="14">Last 14 days</button>
                            <button class="quick-range-btn text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600" data-days="30">Last 30 days</button>
                            <button class="quick-range-btn text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600" data-days="60">Last 60 days</button>
                            <button class="quick-range-btn text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600" data-days="90">Last 90 days</button>
                            <button class="quick-range-btn text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600" data-range="month-to-date">Month to Date</button>
                        </div>
                    </div>
                    
                    <div id="customDateError" class="text-red-500 text-sm hidden"></div>
                </div>
                
                <div class="flex justify-end space-x-2 mt-6">
                    <button id="cancelCustomDate" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors">
                        Cancel
                    </button>
                    <button id="applyCustomDate" class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 rounded-md transition-all">
                        Apply Range
                    </button>
                </div>
            </div>
        </div>
    </div>
    </main>

    <script>
// Dashboard App - jQuery Version with State Filters and Sorting
$(document).ready(function() {
    // State Management
    const state = {
        darkMode: localStorage.getItem('darkMode') === 'true',
        sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true',
        colorCodingDisabled: localStorage.getItem('colorCodingDisabled') === 'true',  // NEW
        dateRangePreset: 'today',
        startDate: '',
        endDate: '',
        includeSpam: false,
        includeAbandoned: false,
        includeDuplicate: false,
        isLoading: false,
        isRefreshing: false,
        dashboardData: {},
        litifyLeads: [],
        filteredLitifyLeads: [],
        litifyBucketFilter: 'all',
        showLitifyDetail: true,
        availableBuckets: [],
        stateFilter: 'all',
        charts: {
            performance: null,
            cost: null
        }
    };

    // Initialize the app
    init();

    function init() {
        console.log('Initializing dashboard...');
        setupEventListeners();
        applyInitialSettings();
        setDateRange('today');
        checkApiStatus();
        fetchData();
    }

    // Apply initial settings
    function applyInitialSettings() {
        if (state.darkMode) {
            $('body').addClass('dark-mode');
            $('#darkModeIcon').removeClass('fa-moon').addClass('fa-sun');
            $('#darkModeText').text('Light Mode');
        }
        
        if (state.sidebarCollapsed) {
            $('#sidebar').addClass('collapsed');
            $('#mainContent').addClass('expanded');
            $('#sidebarIcon').removeClass('fa-chevron-left').addClass('fa-chevron-right');
        }
        
        // Apply color coding setting
        if (state.colorCodingDisabled) {
            $('#disableColorCoding').prop('checked', true);
            $('#colorCodingStatus').show();
        }
    }

    // Setup all event listeners
    function setupEventListeners() {
        $('#sidebarToggle').on('click', toggleSidebar);
        $('#darkModeToggle').on('click', toggleDarkMode);
        
        // NEW: Color coding toggle listener
        $('#disableColorCoding').on('change', function() {
            state.colorCodingDisabled = $(this).prop('checked');
            localStorage.setItem('colorCodingDisabled', state.colorCodingDisabled);
            
            if (state.colorCodingDisabled) {
                $('#colorCodingStatus').show();
            } else {
                $('#colorCodingStatus').hide();
            }
            
            // Re-render tables with new color settings
            renderCampaignTable();
            if (state.litifyLeads && state.litifyLeads.length > 0) {
                renderLitifyTable();
            }
        });
        
        $(document).on('click', '.date-btn', function() {
            const range = $(this).data('range');
            if (range) {
                setDateRange(range);
            }
        });
        
        $(document).on('click', '.state-filter-btn', function() {
            const selectedState = $(this).data('state');
            $('.state-filter-btn').removeClass('active');
            $(this).addClass('active');
            state.stateFilter = selectedState;
            renderCampaignTable();
        });
        
        $('#refreshBtn').on('click', refreshData);
        $('#retryBtn').on('click', function() {
            fetchData();
        });
        $('#exportBtn').on('click', exportData);
        
        $('#includeSpam').on('change', function() {
            state.includeSpam = $(this).prop('checked');
            updateExclusionDisplay();
            fetchData();
        });
        
        $('#includeAbandoned').on('change', function() {
            state.includeAbandoned = $(this).prop('checked');
            updateExclusionDisplay();
            fetchData();
        });
        
        $('#includeDuplicate').on('change', function() {
            state.includeDuplicate = $(this).prop('checked');
            updateExclusionDisplay();
            fetchData();
        });
        
        $('#clearExclusionBtn').on('click', clearExclusionFilters);
        $('#litifyBucketFilter').on('change', filterLitifyLeads);
        $('#litifyToggle').on('click', toggleLitifyDetail);

        // Custom date modal handlers
        $(document).on('click', '.date-btn[data-range="custom"]', function(e) {
            e.preventDefault();
            openCustomDateModal();
        });

        $('#cancelCustomDate').on('click', function() {
            closeCustomDateModal();
        });

        $('#applyCustomDate').on('click', function() {
            applyCustomDateRange();
        });

        // Quick range buttons in modal
        $(document).on('click', '.quick-range-btn', function() {
            const days = $(this).data('days');
            const range = $(this).data('range');
            const today = new Date();
            let startDate, endDate;
            
            if (days) {
                endDate = today;
                startDate = new Date(today);
                startDate.setDate(startDate.getDate() - (days - 1));
            } else if (range === 'month-to-date') {
                endDate = today;
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            }
            
            $('#customStartDate').val(formatDate(startDate));
            $('#customEndDate').val(formatDate(endDate));
        });

        // Close modal on backdrop click
        $('#customDateModal').on('click', function(e) {
            if (e.target === this) {
                closeCustomDateModal();
            }
        });

        // Close modal on Escape key
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && !$('#customDateModal').hasClass('hidden')) {
                closeCustomDateModal();
            }
        });
    }

    function toggleSidebar() {
        state.sidebarCollapsed = !state.sidebarCollapsed;
        
        if (state.sidebarCollapsed) {
            $('#sidebar').addClass('collapsed');
            $('#mainContent').addClass('expanded');
            $('#sidebarIcon').removeClass('fa-chevron-left').addClass('fa-chevron-right');
        } else {
            $('#sidebar').removeClass('collapsed');
            $('#mainContent').removeClass('expanded');
            $('#sidebarIcon').removeClass('fa-chevron-right').addClass('fa-chevron-left');
        }
        
        localStorage.setItem('sidebarCollapsed', state.sidebarCollapsed);
        
        setTimeout(() => {
            if (state.charts.performance) state.charts.performance.resize();
            if (state.charts.cost) state.charts.cost.resize();
        }, 300);
    }

    function toggleDarkMode() {
        state.darkMode = !state.darkMode;
        
        if (state.darkMode) {
            $('body').addClass('dark-mode');
            $('#darkModeIcon').removeClass('fa-moon').addClass('fa-sun');
            $('#darkModeText').text('Light Mode');
        } else {
            $('body').removeClass('dark-mode');
            $('#darkModeIcon').removeClass('fa-sun').addClass('fa-moon');
            $('#darkModeText').text('Dark Mode');
        }
        
        localStorage.setItem('darkMode', state.darkMode);
    }

    function setDateRange(preset) {
        state.dateRangePreset = preset;
        const today = new Date();
        let start, end;
        
        switch(preset) {
            case 'today':
                start = end = formatDate(today);
                break;
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                start = end = formatDate(yesterday);
                break;
            case 'week':
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 6);
                start = formatDate(weekAgo);
                end = formatDate(today);
                break;
            case 'month':
                const monthAgo = new Date(today);
                monthAgo.setDate(monthAgo.getDate() - 29);
                start = formatDate(monthAgo);
                end = formatDate(today);
                break;
            case 'custom':
            openCustomDateModal();
            return; // Don't fetch data yet, wait for user to apply
        }
        
        state.startDate = start;
        state.endDate = end;
        
        $('.date-btn').removeClass('active');
        $(`.date-btn[data-range="${preset}"]`).addClass('active');
        updateDateRangeText();
        
        fetchData();
    }

    function updateDateRangeText() {
        let text = '';
        if (state.startDate === state.endDate) {
            text = formatDisplayDate(state.startDate);
        } else {
            text = `${formatDisplayDate(state.startDate)} - ${formatDisplayDate(state.endDate)}`;
        }
        $('#dateRangeText').text(text);
    }

    function checkApiStatus() {
        $.ajax({
            url: '/api/status',
            method: 'GET',
            success: function(response) {
                const googleStatus = response.google_ads_connected;
                const litifyStatus = response.litify_connected;
                
                $('#googleAdsStatus')
                    .removeClass('bg-amber-500 bg-green-500 bg-red-500')
                    .addClass(googleStatus ? 'bg-green-500' : 'bg-red-500');
                
                $('#litifyStatus')
                    .removeClass('bg-amber-500 bg-green-500 bg-red-500')
                    .addClass(litifyStatus ? 'bg-green-500' : 'bg-red-500');
            }
        });
    }

    function openCustomDateModal() {
    // Set default values to current date range
    $('#customStartDate').val(state.startDate || formatDate(new Date()));
    $('#customEndDate').val(state.endDate || formatDate(new Date()));
    $('#customDateError').addClass('hidden').text('');
    
    // Show modal with animation
    $('#customDateModal').removeClass('hidden').css('opacity', '0');
    setTimeout(() => {
        $('#customDateModal').css('opacity', '1');
    }, 10);
}

function closeCustomDateModal() {
    $('#customDateModal').css('opacity', '0');
    setTimeout(() => {
        $('#customDateModal').addClass('hidden');
    }, 300);
}

function applyCustomDateRange() {
    const startDate = $('#customStartDate').val();
    const endDate = $('#customEndDate').val();
    
    // Validation
    if (!startDate || !endDate) {
        $('#customDateError').removeClass('hidden').text('Please select both start and end dates');
        return;
    }
    
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        $('#customDateError').removeClass('hidden').text('Start date must be before end date');
        return;
    }
    
    // Check if date range is too large (optional - e.g., max 365 days)
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    if (daysDiff > 365) {
        $('#customDateError').removeClass('hidden').text('Date range cannot exceed 365 days');
        return;
    }
    
    // Apply the date range
    state.dateRangePreset = 'custom';
    state.startDate = startDate;
    state.endDate = endDate;
    
    // Update UI
    $('.date-btn').removeClass('active');
    $('.date-btn[data-range="custom"]').addClass('active');
    updateDateRangeText();
    
    // Close modal
    closeCustomDateModal();
    
    // Fetch new data
    fetchData();
}

    function fetchData(forceRefresh = false) {
        if (state.isLoading) return;
        
        state.isLoading = true;
        
        $('#loadingState').show();
        $('#errorState').hide();
        $('#dashboardContent').hide();
        
        $.ajax({
            url: '/api/dashboard-data',
            method: 'GET',
            data: {
                start_date: state.startDate,
                end_date: state.endDate,
                include_spam: state.includeSpam,
                include_abandoned: state.includeAbandoned,
                include_duplicate: state.includeDuplicate,
                force_refresh: forceRefresh,
                _t: new Date().getTime()  // Add cache buster
            },
            success: function(response) {
                console.log('Raw response leads:', response.litify_leads);
                
                state.dashboardData = response;
                
                state.litifyLeads = response.litify_leads || [];
                // Filter litify leads to only show those created in period
                // Use the count_for_leads flag from backend
                state.litifyLeads = (response.litify_leads || []).filter(lead => {
                    // Only include leads that were created in this period
                    return lead.count_for_leads === true;
                });
                
                console.log('Filtered leads (created in period only):', state.litifyLeads);
                console.log('Date range:', state.startDate, 'to', state.endDate);
                
                state.availableBuckets = response.available_buckets || [];
                
                // Add leads summary section above the table
                const leadsSummary = calculateLeadsSummary();
                renderLeadsSummary(leadsSummary);
                
                updateExclusionCounts();
                filterLitifyLeads();
                renderDashboard();
                
                $('#loadingState').hide();
                $('#dashboardContent').show();
                
                if (forceRefresh) {
                    $('#refreshIcon').removeClass('fa-spin');
                    const $refreshBtn = $('#refreshBtn');
                    const $refreshIcon = $('#refreshIcon');
                    
                    $refreshIcon.removeClass('fa-sync-alt fa-spin').addClass('fa-check');
                    $refreshBtn.removeClass('btn-primary').addClass('btn-success');
                    
                    setTimeout(() => {
                        $refreshIcon.removeClass('fa-check').addClass('fa-sync-alt');
                        $refreshBtn.removeClass('btn-success').addClass('btn-primary');
                    }, 2000);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = 'Failed to load dashboard data. Please try again.';
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) {
                        errorMessage = response.error;
                    }
                } catch (e) {}
                
                $('#errorMessage').text(errorMessage);
                $('#loadingState').hide();
                $('#errorState').show();
            },
            complete: function() {
                state.isLoading = false;
                state.isRefreshing = false;
                if ($('#refreshIcon').hasClass('fa-sync-alt')) {
                    $('#refreshIcon').removeClass('fa-spin');
                }
            }
        });
    }

    function calculateLeadsSummary() {
        // Use the filtered leads that are actually displayed
        const leads = state.filteredLitifyLeads || [];
        const summary = {
            created_today: 0,
            converted_today: 0,
            total: leads.length
        };
        
        leads.forEach(lead => {
            // These are all created in the selected period now
            summary.created_today++;
            
            if (lead.converted_today || (lead.is_converted && lead.conversion_date === state.endDate)) {
                summary.converted_today++;
            }
        });
        
        return summary;
    }

    function renderLeadsSummary(summary) {
        // This will be inserted into the litify section header
        const summaryHtml = `
            <!-- 
                <div class="flex items-center space-x-4 text-sm">
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">
                    <i class="fas fa-plus-circle mr-1"></i>
                    ${summary.created_today} New Today
                </span>
                <span class="px-2 py-1 bg-green-100 text-green-800 rounded">
                    <i class="fas fa-check-circle mr-1"></i>
                    ${summary.converted_today} Converted Today
                </span>
                <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded">
                    <i class="fas fa-list mr-1"></i>
                    ${summary.total} Total
                </span>
            </div>
            -->
        `;
        
        // Update the litify section description with summary
        const existingText = $('#litifyLeadsCount').parent().html();
        if (!existingText.includes('New Today')) {
            $('#litifyLeadsCount').parent().append(summaryHtml);
        }
    }

    function refreshData() {
        if (state.isRefreshing) return;
        state.isRefreshing = true;
        $('#refreshIcon').addClass('fa-spin');
        fetchData(true);
    }

    function updateExclusionCounts() {
        const excluded = state.dashboardData.excluded_lead_counts || {};
        $('#spamCount').text(excluded.spam || 0);
        $('#abandonedCount').text(excluded.abandoned || 0);
        $('#duplicateCount').text(excluded.duplicate || 0);
    }

    function updateExclusionDisplay() {
        const hasFilters = state.includeSpam || state.includeAbandoned || state.includeDuplicate;
        
        if (hasFilters) {
            const filters = [];
            if (state.includeSpam) filters.push('Spam');
            if (state.includeAbandoned) filters.push('Abandoned');
            if (state.includeDuplicate) filters.push('Duplicate');
            
            $('#exclusionList').text(filters.join(', '));
            $('#exclusionText').show();
            $('#exclusionAlert').show();
            
            const excluded = state.dashboardData.excluded_lead_counts || {};
            let count = 0;
            if (state.includeSpam) count += excluded.spam || 0;
            if (state.includeAbandoned) count += excluded.abandoned || 0;
            if (state.includeDuplicate) count += excluded.duplicate || 0;
            $('#includedCount').text(count);
        } else {
            $('#exclusionText').hide();
            $('#exclusionAlert').hide();
        }
        
        updateFilterText();
    }

    function updateFilterText() {
        const filters = [];
        if (state.includeSpam) filters.push('Spam');
        if (state.includeAbandoned) filters.push('Abandoned');
        if (state.includeDuplicate) filters.push('Duplicate');
        
        if (filters.length > 0) {
            $('#filterText').text(`Including: ${filters.join(', ')}`);
        } else {
            $('#filterText').text('Standard filters');
        }
    }

    function clearExclusionFilters() {
        state.includeSpam = false;
        state.includeAbandoned = false;
        state.includeDuplicate = false;
        
        $('#includeSpam, #includeAbandoned, #includeDuplicate').prop('checked', false);
        updateExclusionDisplay();
        fetchData();
    }

    function filterLitifyLeads() {
        const filter = $('#litifyBucketFilter').val() || 'all';
        state.litifyBucketFilter = filter;
        
        // Start with all leads
        let filtered = state.litifyLeads;
        
        // Filter by date range AND the count_for_leads flag
        // This ensures we only show leads that were actually created in the period
        filtered = filtered.filter(lead => {
            // First check if this lead should be counted (created in period)
            if (!lead.count_for_leads) {
                return false;  // Skip leads from previous periods
            }
            
            if (!lead.created_date) return false;
            
            // Parse the created date as a proper Date object
            const createdDate = new Date(lead.created_date);
            
            // Convert to Pacific Time string in YYYY-MM-DD format
            const createdDatePT = createdDate.toLocaleDateString('en-CA', {
                timeZone: 'America/Los_Angeles'
            }); // en-CA gives YYYY-MM-DD format
            
            // Compare to our selected date range
            return createdDatePT >= state.startDate && createdDatePT <= state.endDate;
        });
        
        // Then apply bucket filter if needed
        if (filter !== 'all') {
            filtered = filtered.filter(lead => lead.bucket === filter);
            $('#litifyBucketText').html(` in <span class="font-medium text-gray-700 dark-mode:text-gray-300">${filter}</span>`);
        } else {
            $('#litifyBucketText').text('');
        }
        
        state.filteredLitifyLeads = filtered;
        $('#litifyLeadsCount').text(state.filteredLitifyLeads.length);
        renderLitifyTable();
    }

    function toggleLitifyDetail() {
        state.showLitifyDetail = !state.showLitifyDetail;
        
        if (state.showLitifyDetail) {
            $('#litifyDetail').slideDown();
            $('#litifyToggleIcon').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            renderLitifyTable();
        } else {
            $('#litifyDetail').slideUp();
            $('#litifyToggleIcon').removeClass('fa-chevron-up').addClass('fa-chevron-down');
        }
    }

    function renderDashboard() {
        renderSummaryCards();
        renderCampaignTable();
        renderCharts();
        updateKeyInsights();
        
        if (state.litifyLeads && state.litifyLeads.length > 0) {
            $('#litifySection').show();
            $('#litifyDetail').show();
            $('#litifyToggleIcon').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            updateBucketFilter();
            $('#litifyLeadsCount').text(state.filteredLitifyLeads.length);
            renderLitifyTable();
        } else {
            $('#litifySection').hide();
        }
    }

    function renderSummaryCards() {
        const buckets = state.dashboardData.buckets || [];
        
        const totals = {
            spend: 0,
            leads: 0,
            cases: 0,
            retainers: 0,
            inPractice: 0
        };
        
        buckets.forEach(bucket => {
            if (!bucket.name.includes('Youtube') && !bucket.name.includes('Crisp')) {
                totals.spend += bucket.cost || 0;
                totals.leads += bucket.leads || 0;
                totals.cases += bucket.cases || 0;
                totals.retainers += bucket.retainers || 0;
                totals.inPractice += bucket.inPractice || 0;
            }
        });
        
        const avgCPL = totals.leads > 0 ? totals.spend / totals.leads : 0;
        const avgCPA = totals.cases > 0 ? totals.spend / totals.cases : 0;
        const avgCPR = totals.retainers > 0 ? totals.spend / totals.retainers : 0;
        const convRate = totals.inPractice > 0 ? (totals.retainers / totals.inPractice) : 0;
        
        const cards = `
            <div class="metric-card">
                <div class="metric-label">Ad Spend</div>
                <div class="metric-value">${formatCurrency(totals.spend)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Leads</div>
                <div class="metric-value text-green-600">${formatNumber(totals.leads)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CPL</div>
                <div class="metric-value">${formatCurrency(avgCPL)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cases</div>
                <div class="metric-value text-blue-600">${formatNumber(totals.cases)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CPA</div>
                <div class="metric-value">${formatCurrency(avgCPA)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Retainers</div>
                <div class="metric-value text-purple-600">${formatNumber(totals.retainers)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CPR</div>
                <div class="metric-value">${formatCurrency(avgCPR)}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Conv Rate</div>
                <div class="metric-value">${formatPercentage(totals.cases/totals.leads)}</div>
            </div>
        `;
        $('#summaryCards').html(cards);
    }

    // MODIFIED: Now respects the colorCodingDisabled state
    function getMetricColorClass(value, type, isText = true) {
        // If color coding is disabled, return empty string
        if (state.colorCodingDisabled) {
            return '';
        }
        
        const prefix = isText ? 'text-' : 'bg-';
        
        switch(type) {
            case 'cpl':
                if (value <= 800) return prefix + 'green-600';
                if (value <= 1200) return prefix + 'yellow-600';
                return prefix + 'red-600';
            case 'cpa':
                if (value <= 3000) return prefix + 'green-600';
                if (value <= 5000) return prefix + 'yellow-600';
                return prefix + 'red-600';
            case 'cpr':
                if (value <= 4000) return prefix + 'green-600';
                if (value <= 6000) return prefix + 'yellow-600';
                return prefix + 'red-600';
            case 'conversion':
                if (value >= 0.25) return prefix + 'green-600';
                if (value >= 0.15) return prefix + 'yellow-600';
                return prefix + 'red-600';
            case 'inpractice':
                if (value >= 0.8) return prefix + 'green-600';
                if (value >= 0.6) return prefix + 'yellow-600';
                return prefix + 'red-600';
            case 'unqualified':
                if (value <= 0.2) return prefix + 'green-600';
                if (value <= 0.35) return prefix + 'yellow-600';
                return prefix + 'red-600';
            default:
                return '';
        }
    }

    function getFullStateName(abbr) {
        const states = {
            'CA': 'California',
            'AZ': 'Arizona', 
            'GA': 'Georgia',
            'TX': 'Texas'
        };
        return states[abbr] || abbr;
    }

    function renderCampaignTable() {
        const buckets = state.dashboardData.buckets || [];
        
        // Filter by state if needed
        let filteredBuckets = buckets;
        if (state.stateFilter !== 'all') {
            filteredBuckets = buckets.filter(bucket => {
                return bucket.name.includes(state.stateFilter) || 
                       bucket.name.includes(getFullStateName(state.stateFilter));
            });
        }
        
        // Render header
        const headerHtml = `
            <th class="table-cell text-left">Bucket</th>
            <th class="table-cell text-right">Spend</th>
            <th class="table-cell text-right">Leads</th>
            <th class="table-cell text-right">In Practice</th>
            <th class="table-cell text-right">In Practice %</th>
            <th class="table-cell text-right">Unqualified</th>
            <th class="table-cell text-right">Unqualified %</th>
            <th class="table-cell text-right">CPL</th>
            <th class="table-cell text-right">Cases</th>
            <th class="table-cell text-right">CPA</th>
            <th class="table-cell text-right">Retainers</th>
            <th class="table-cell text-right">Pending</th>
           <!--  <th class="table-cell text-right">All Retainers</th> --> 
            <th class="table-cell text-right">CPR</th>
            <th class="table-cell text-right">Conv %</th>
        `;
        $('#tableHeader').html(headerHtml);
        
        // Sort buckets by state, then by type
        const sortedBuckets = filteredBuckets.sort((a, b) => {
            // Extract state from bucket name
            const getState = (name) => {
                if (name.includes('California') || name.includes('CA')) return 1;
                if (name.includes('Arizona') || name.includes('AZ')) return 2;
                if (name.includes('Georgia') || name.includes('GA')) return 3;
                if (name.includes('Texas') || name.includes('TX')) return 4;
                return 5;
            };
            
            // Extract type from bucket name
            const getType = (name) => {
                if (name.toLowerCase().includes('prospecting')) return 1;
                if (name.toLowerCase().includes('lsa')) return 2;
                if (name.toLowerCase().includes('brand')) return 3;
                return 4;
            };
            
            const stateA = getState(a.name);
            const stateB = getState(b.name);
            
            if (stateA !== stateB) {
                return stateA - stateB;
            }
            
            return getType(a.name) - getType(b.name);
        });
        
        // Render body
        let bodyHtml = '';
        let totalRow = {
            spend: 0,
            leads: 0,
            inPractice: 0,
            unqualified: 0,
            cases: 0,
            retainers: 0,
            pendingRetainers: 0,
            totalRetainers: 0
        };
        
        // Separate YouTube/Crisp bucket
        let youtubeBucket = null;
        
        sortedBuckets.forEach(bucket => {
            if (true) {
                // Check if this is Crisp/Youtube
                if (bucket.name.includes('Youtube') || bucket.name.includes('Crisp')) {
                    youtubeBucket = bucket;
                } else {
                    // Add to totals
                    totalRow.spend += bucket.cost || 0;
                    totalRow.leads += bucket.leads || 0;
                    totalRow.inPractice += bucket.inPractice || 0;
                    totalRow.unqualified += bucket.unqualified || 0;
                    totalRow.cases += bucket.cases || 0;
                    totalRow.retainers += bucket.retainers || 0;
                    totalRow.pendingRetainers += bucket.pendingRetainers || 0;
                    // totalRow.totalRetainers += bucket.totalRetainers || 0;
                    
                    // Apply color coding (now respects disabled state)
                    const cplColor = getMetricColorClass(bucket.costPerLead, 'cpl');
                    const cpaColor = getMetricColorClass(bucket.cpa, 'cpa');
                    const cprColor = getMetricColorClass(bucket.costPerRetainer, 'cpr');
                    const convColor = getMetricColorClass(bucket.conversionRate, 'conversion');
                    const inPracticeColor = getMetricColorClass(bucket.inPracticePercent, 'inpractice');
                    const unqualifiedColor = getMetricColorClass(bucket.unqualifiedPercent, 'unqualified');
                    
                    bodyHtml += `
                        <tr class="table-row">
                            <td class="table-cell font-medium">${bucket.name}</td>
                            <td class="table-cell text-right">${formatCurrency(bucket.cost)}</td>
                            <td class="table-cell text-center">${formatNumber(bucket.leads)}</td>
                            <td class="table-cell text-center">${formatNumber(bucket.inPractice)}</td>
                            <td class="table-cell text-center ${inPracticeColor}">${formatPercentage(bucket.inPracticePercent)}</td>
                            <td class="table-cell text-center">${formatNumber(bucket.unqualified)}</td>
                            <td class="table-cell text-center ${unqualifiedColor}">${formatPercentage(bucket.unqualifiedPercent)}</td>
                            <td class="table-cell text-center ${cplColor} font-semibold">${formatCurrency(bucket.costPerLead)}</td>
                            <td class="table-cell text-center">${formatNumber(bucket.cases)}</td>
                            <td class="table-cell text-center ${cpaColor} font-semibold">${formatCurrency(bucket.cpa)}</td>
                            <td class="table-cell text-center">${formatNumber(bucket.retainers)}</td>
                            <td class="table-cell text-center">${formatNumber(bucket.pendingRetainers || 0)}</td>
                            <!-- <td class="table-cell text-center font-semibold">${formatNumber(bucket.totalRetainers || bucket.retainers)}</td> -->
                            <td class="table-cell text-right ${cprColor} font-semibold">${formatCurrency(bucket.costPerRetainer)}</td>
                            <td class="table-cell text-right ${convColor} font-semibold">${formatPercentage(bucket.conversionRate)}</td>
                        </tr>
                    `;
                }
            }
        });
        
        // Add total row (excluding YouTube)
        if (bodyHtml) {
            const totalCPL = totalRow.leads > 0 ? totalRow.spend / totalRow.leads : 0;
            const totalCPA = totalRow.cases > 0 ? totalRow.spend / totalRow.cases : 0;
            const totalCPR = totalRow.retainers > 0 ? totalRow.spend / totalRow.retainers : 0;
            const totalConv = totalRow.cases > 0 ? totalRow.cases / totalRow.leads : 0;
            const totalInPracticePct = totalRow.leads > 0 ? totalRow.inPractice / totalRow.leads : 0;
            const totalUnqualifiedPct = totalRow.inPractice > 0 ? totalRow.unqualified / totalRow.inPractice : 0;
            
            // Apply color coding to totals (now respects disabled state)
            const totalCplColor = getMetricColorClass(totalCPL, 'cpl');
            const totalCpaColor = getMetricColorClass(totalCPA, 'cpa');
            const totalCprColor = getMetricColorClass(totalCPR, 'cpr');
            const totalConvColor = getMetricColorClass(totalConv, 'conversion');
            const totalInPracticeColor = getMetricColorClass(totalInPracticePct, 'inpractice');
            const totalUnqualifiedColor = getMetricColorClass(totalUnqualifiedPct, 'unqualified');
            
            bodyHtml += `
                <tr class="table-row font-bold bg-gray-100 dark-mode:bg-gray-800">
                    <td class="table-cell">Total (excl. YouTube)</td>
                    <td class="table-cell text-center">${formatCurrency(totalRow.spend)}</td>
                    <td class="table-cell text-center">${formatNumber(totalRow.leads)}</td>
                    <td class="table-cell text-center">${formatNumber(totalRow.inPractice)}</td>
                    <td class="table-cell text-center ${totalInPracticeColor}">${formatPercentage(totalInPracticePct)}</td>
                    <td class="table-cell text-center">${formatNumber(totalRow.unqualified)}</td>
                    <td class="table-cell text-center ${totalUnqualifiedColor}">${formatPercentage(totalUnqualifiedPct)}</td>
                    <td class="table-cell text-center ${totalCplColor}">${formatCurrency(totalCPL)}</td>
                    <td class="table-cell text-center">${formatNumber(totalRow.cases)}</td>
                    <td class="table-cell text-center ${totalCpaColor}">${formatCurrency(totalCPA)}</td>
                    <td class="table-cell text-center">${formatNumber(totalRow.retainers)}</td>
                    <td class="table-cell text-center">${formatNumber(totalRow.pendingRetainers)}</td>
                    <!-- <td class="table-cell text-center">${formatNumber(totalRow.totalRetainers)}</td> -->
                    <td class="table-cell text-center ${totalCprColor}">${formatCurrency(totalCPR)}</td>
                    <td class="table-cell text-center ${totalConvColor}">${formatPercentage(totalConv)}</td>
                </tr>
            `;
            
            // Add YouTube/Crisp row if exists (with color coding)
            if (youtubeBucket) {
                const ytCplColor = getMetricColorClass(youtubeBucket.costPerLead, 'cpl');
                const ytCpaColor = getMetricColorClass(youtubeBucket.cpa, 'cpa');
                const ytCprColor = getMetricColorClass(youtubeBucket.costPerRetainer, 'cpr');
                const ytConvColor = getMetricColorClass(youtubeBucket.conversionRate, 'conversion');
                const ytInPracticeColor = getMetricColorClass(youtubeBucket.inPracticePercent, 'inpractice');
                const ytUnqualifiedColor = getMetricColorClass(youtubeBucket.unqualifiedPercent, 'unqualified');
                
                bodyHtml += `
                    <tr class="youtube-row">
                        <td class="table-cell font-medium">
                            <i class="fab fa-youtube mr-2 text-red-600"></i>
                            ${youtubeBucket.name}
                        </td>
                        <td class="table-cell text-right">${formatCurrency(youtubeBucket.cost)}</td>
                        <td class="table-cell text-center">${formatNumber(youtubeBucket.leads)}</td>
                        <td class="table-cell text-center">${formatNumber(youtubeBucket.inPractice)}</td>
                        <td class="table-cell text-center ${ytInPracticeColor}">${formatPercentage(youtubeBucket.inPracticePercent)}</td>
                        <td class="table-cell text-center">${formatNumber(youtubeBucket.unqualified)}</td>
                        <td class="table-cell text-center ${ytUnqualifiedColor}">${formatPercentage(youtubeBucket.unqualifiedPercent)}</td>
                        <td class="table-cell text-center ${ytCplColor} font-semibold">${formatCurrency(youtubeBucket.costPerLead)}</td>
                        <td class="table-cell text-center">${formatNumber(youtubeBucket.cases)}</td>
                        <td class="table-cell text-center ${ytCpaColor} font-semibold">${formatCurrency(youtubeBucket.cpa)}</td>
                        <td class="table-cell text-center">${formatNumber(youtubeBucket.retainers)}</td>
                        <td class="table-cell text-center">${formatNumber(youtubeBucket.pendingRetainers || 0)}</td>
                        <td class="table-cell text-center font-semibold">${formatNumber(youtubeBucket.totalRetainers || youtubeBucket.retainers)}</td>
                        <!-- <td class="table-cell text-right ${ytCprColor} font-semibold">${formatCurrency(youtubeBucket.costPerRetainer)}</td> --> 
                        <td class="table-cell text-right ${ytConvColor} font-semibold">${formatPercentage(youtubeBucket.conversionRate)}</td>
                    </tr>
                `;
            }
        } else {
            bodyHtml = '<tr><td colspan="15" class="text-center py-4 text-gray-500">No campaign data available</td></tr>';
        }
        
        $('#tableBody').html(bodyHtml);
    }

    function renderLitifyTable() {
    const leads = state.filteredLitifyLeads;
    
    // Updated header with both date columns
    const headerHtml = `
        <th class="table-cell text-left">Created Date</th>
        <th class="table-cell text-left">Client</th>
        <!-- <th class="table-cell text-left">Conversion Date</th> -->
        <th class="table-cell text-left">Status</th>
        <th class="table-cell text-left">Case Type</th>
        <th class="table-cell text-center">In Practice</th>
        <th class="table-cell text-left">Bucket</th>
        <th class="table-cell text-left">UTM Campaign</th>
        <th class="table-cell text-center">Converted</th>
    `;
    $('#litifyTableHeader').html(headerHtml);
    
    let bodyHtml = '';
    leads.forEach(lead => {
        // Determine row styling based on dates
        let rowClass = '';
        let badge = '';
        
        if (lead.is_new_today) {
            rowClass = '';  // Light blue background
            badge = '';
        } else if (lead.converted_today) {
            rowClass = '';  // Light green background
            badge = '';
        }
        
        // Format dates
        const createdDate = lead.created_date_formatted || formatDateTime(lead.created_date);
        
        // Format conversion date properly
        let conversionDateDisplay = '';
        if (lead.conversion_date || lead.retainer_signed_date) {
            const dateStr = lead.conversion_date || lead.retainer_signed_date;
            // Format YYYY-MM-DD to a nicer format
            if (dateStr && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = dateStr.split('-');
                const date = new Date(parts[0], parts[1] - 1, parts[2]);
                conversionDateDisplay = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    timeZone: 'America/Los_Angeles'
                });
            } else {
                conversionDateDisplay = dateStr;
            }
        }
        
        // Apply color only if color coding is enabled
        const isConverted = lead.is_converted ? 
            (state.colorCodingDisabled ? 
                '<span class="font-semibold">Yes</span>' : 
                '<span class="text-green-600 font-semibold">Yes</span>') : 
            (state.colorCodingDisabled ? 
                '<span>No</span>' : 
                '<span class="text-red-600">No</span>');
        
        const inPractice = lead.in_practice ? 
            (state.colorCodingDisabled ? 
                '<span class="font-semibold">Yes</span>' : 
                '<span class="text-green-600 font-semibold">Yes</span>') : 
            (state.colorCodingDisabled ? 
                '<span>No</span>' : 
                '<span class="text-red-600">No</span>');
        
        let clientDisplay = lead.client_name || lead.name || '-';
        
        const intakeId = lead.id || lead.intake_id || lead.litify_pm__intake__c || lead.Intake__c;
        
        if (intakeId && intakeId !== '-' && clientDisplay !== '-') {
            const litifyUrl = lead.salesforce_url || 
                `https://sweetjames.lightning.force.com/lightning/r/litify_pm__Intake__c/${intakeId}/view`;
            clientDisplay = `<a href="${litifyUrl}" 
                target="_blank" 
                class="client-link"
                title="View intake record in Litify">
                ${lead.client_name || lead.name}
                <i class="fas fa-external-link-alt text-xs ml-1"></i>
            </a>`;
        }
        
        bodyHtml += `
            <tr class="table-row ${rowClass}">
                <td class="table-cell">
                    <small class="text-gray-600">${createdDate}</small>
                </td>
                <td class="table-cell">
                    ${clientDisplay}
                    ${badge}
                </td>
                
                <!-- <td class="table-cell">
                    ${conversionDateDisplay ? 
                        `<small class="text-green-600 font-semibold">${conversionDateDisplay}</small>` : 
                        '<small class="text-gray-400">-</small>'}
                </td>
                -->
                <td class="table-cell">
                    <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(lead.status)}">
                        ${lead.status}
                    </span>
                </td>
                <td class="table-cell text-sm">${lead.case_type || '-'}</td>
                <td class="table-cell text-center">${inPractice}</td>
                <td class="table-cell">
                    <span class="px-2 py-1 text-xs bg-gray-100 dark-mode:bg-gray-700 rounded">
                        ${lead.bucket || 'Unmapped'}
                    </span>
                </td>
                <td class="table-cell text-xs text-gray-600 dark-mode:text-gray-400">${lead.utm_campaign || '-'}</td>
                <td class="table-cell text-center">${isConverted}</td>
            </tr>
        `;
    });
    
    if (leads.length === 0) {
        bodyHtml = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No leads found for the selected filter</td></tr>';
    }
    
    $('#litifyTableBody').html(bodyHtml);
}

    function updateBucketFilter() {
        const select = $('#litifyBucketFilter');
        select.find('option:gt(0)').remove();
        
        const uniqueBuckets = [...new Set(state.litifyLeads.map(lead => lead.bucket).filter(b => b))];
        
        uniqueBuckets.forEach(bucket => {
            select.append(`<option value="${bucket}">${bucket}</option>`);
        });
    }

    function renderCharts() {
        renderPerformanceChart();
        renderCostChart();
    }

    function renderPerformanceChart() {
        const ctx = document.getElementById('performanceChart');
        if (!ctx) return;
        
        const buckets = state.dashboardData.buckets || [];
        
        if (state.charts.performance) {
            state.charts.performance.destroy();
        }
        
        const activeBuckets = buckets.filter(b => 
            b.leads > 0 && !b.name.includes('Youtube') && !b.name.includes('Crisp')
        );
        const labels = activeBuckets.map(b => {
            return b.name.replace('California', 'CA')
                         .replace('Arizona', 'AZ')
                         .replace('Georgia', 'GA')
                         .replace('Texas', 'TX');
        });
        const leadsData = activeBuckets.map(b => b.leads);
        const casesData = activeBuckets.map(b => b.cases);
        const retainersData = activeBuckets.map(b => b.retainers);
        
        state.charts.performance = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Leads',
                    data: leadsData,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: '#10b981',
                    borderWidth: 1
                }, {
                    label: 'Cases',
                    data: casesData,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }, {
                    label: 'Retainers',
                    data: retainersData,
                    backgroundColor: 'rgba(139, 92, 246, 0.7)',
                    borderColor: '#8b5cf6',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 11
                            },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    function renderCostChart() {
        const ctx = document.getElementById('costChart');
        if (!ctx) return;
        
        const buckets = state.dashboardData.buckets || [];
        
        if (state.charts.cost) {
            state.charts.cost.destroy();
        }
        
        const filteredBuckets = buckets.filter(b => 
            b.cost > 0 && !b.name.includes('Youtube') && !b.name.includes('Crisp')
        );
        
        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe', '#43e97b',
            '#38f9d7', '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3'
        ];
        
        state.charts.cost = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: filteredBuckets.map(b => b.name),
                datasets: [{
                    data: filteredBuckets.map(b => b.cost),
                    backgroundColor: colors.slice(0, filteredBuckets.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = formatCurrency(context.raw);
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.raw / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updateKeyInsights() {
        const buckets = state.dashboardData.buckets || [];
        const activeBuckets = buckets.filter(b => 
            b.leads > 0 && !b.name.includes('Youtube') && !b.name.includes('Crisp')
        );
        
        if (activeBuckets.length === 0) {
            $('#bestConversion, #lowestCPL, #highestVolume, #mostEfficient').text('N/A');
            return;
        }
        
        const bestConv = activeBuckets.reduce((best, curr) => 
            (curr.conversionRate > best.conversionRate) ? curr : best, 
            activeBuckets[0]
        );
        $('#bestConversion').text(bestConv.name ? `${bestConv.name} (${formatPercentage(bestConv.conversionRate)})` : 'N/A');
        
        const lowestCPL = activeBuckets.reduce((lowest, curr) => 
            (curr.costPerLead < lowest.costPerLead && curr.costPerLead > 0) ? curr : lowest,
            activeBuckets[0]
        );
        $('#lowestCPL').text(lowestCPL.name ? `${lowestCPL.name} (${formatCurrency(lowestCPL.costPerLead)})` : 'N/A');
        
        const highestVol = activeBuckets.reduce((highest, curr) => 
            (curr.leads > highest.leads) ? curr : highest,
            activeBuckets[0]
        );
        $('#highestVolume').text(highestVol.name ? `${highestVol.name} (${formatNumber(highestVol.leads)} leads)` : 'N/A');
        
        const mostEfficient = activeBuckets.filter(b => b.cpa > 0).reduce((best, curr) => 
            (curr.cpa < best.cpa) ? curr : best,
            activeBuckets.find(b => b.cpa > 0) || activeBuckets[0]
        );
        $('#mostEfficient').text(mostEfficient && mostEfficient.cpa > 0 ? 
            `${mostEfficient.name} (${formatCurrency(mostEfficient.cpa)})` : 'N/A');
    }

    function exportData() {
        const params = {
            start_date: state.startDate,
            end_date: state.endDate,
            include_spam: state.includeSpam,
            include_abandoned: state.includeAbandoned,
            include_duplicate: state.includeDuplicate
        };
        
        const queryString = $.param(params);
        window.location.href = `/api/export?${queryString}`;
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDisplayDate(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split('-');
        const date = new Date(parts[0], parts[1] - 1, parts[2]);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            timeZone: 'America/Los_Angeles'
        });
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        
        // Check if this is already formatted (contains "PT")
        if (dateStr.includes(' PT')) {
            return dateStr;
        }
        
        const date = new Date(dateStr);
        
        if (isNaN(date.getTime())) {
            // Try to parse YYYY-MM-DD format
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const localDate = new Date(parts[0], parts[1] - 1, parts[2]);
                return localDate.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'America/Los_Angeles'
                });
            }
            return dateStr;  // Return as-is if we can't parse it
        }
        
        return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit', 
            minute: '2-digit',
            timeZone: 'America/Los_Angeles'
        });
    }

    function formatCurrency(value) {
        if (value === null || value === undefined || isNaN(value)) return '$0';
        return '$' + Math.round(value).toLocaleString('en-US');
    }

    function formatNumber(value) {
        if (value === null || value === undefined || isNaN(value)) return '0';
        return Math.round(value).toLocaleString('en-US');
    }

    function formatPercentage(value) {
        if (value === null || value === undefined || isNaN(value)) return '0%';
        return (value * 100).toFixed(1) + '%';
    }

    function getStatusClass(status) {
        const statusClasses = {
            'New': 'bg-blue-100 text-blue-800',
            'Contacted': 'bg-yellow-100 text-yellow-800',
            'Qualified': 'bg-green-100 text-green-800',
            'Converted': 'bg-green-100 text-green-800',
            'Retained': 'bg-green-100 text-green-800',
            'Retainer Sent': 'bg-amber-100 text-amber-800',
            'Closed': 'bg-gray-100 text-gray-800',
            'Converted DAI': 'bg-red-100 text-red-800',
            'Turned Down': 'bg-red-100 text-red-800',
            'Referred Out': 'bg-orange-100 text-orange-800',
            'Unknown': 'bg-gray-100 text-gray-800'
        };
        return statusClasses[status] || 'bg-gray-100 text-gray-800';
    }
});
</script>

</body>
</html>