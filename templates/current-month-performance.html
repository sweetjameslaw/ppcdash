<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Month Performance - Sweet James Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Sidebar Layout - Matching dashboard.html */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 40;
        }
        
        .sidebar.collapsed {
            width: 0;
            overflow: hidden;
        }
        
        body.dark-mode .sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }
        
        .main-content {
            margin-left: 280px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* Sidebar Toggle Button - Fixed positioning */
        .sidebar-toggle {
            position: fixed;
            left: 260px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: left 0.3s ease;
        }
        
        .sidebar.collapsed ~ .sidebar-toggle {
            left: -16px;
        }
        
        body.dark-mode .sidebar-toggle {
            background: #1f2937;
            border-color: #374151;
        }
        
        /* Navigation links */
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .nav-link:hover {
            background: #f3f4f6;
            color: #111827;
        }
        
        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-link.active i {
            color: white !important;
        }
        
        body.dark-mode .nav-link {
            color: #d1d5db;
        }
        
        body.dark-mode .nav-link:hover {
            background: #374151;
            color: #f3f4f6;
        }
        
        body.dark-mode .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Metric Cards */
        .metric-card {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.2;
        }
        
        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .metric-change.positive {
            color: #10b981;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #475569;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #667eea;
            color: #667eea;
        }
        
        /* State Filter Buttons */
        .state-filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            background: white;
            color: #475569;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .state-filter-btn:hover {
            background: #f8fafc;
            border-color: #667eea;
        }
        
        .state-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        
        /* View Toggle */
        .view-toggle {
            background: #f1f5f9;
            padding: 0.25rem;
            border-radius: 8px;
            display: inline-flex;
        }
        
        .view-toggle button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .view-toggle button.active {
            background: white;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Table */
        .data-table {
            background: white;
            border-radius: 8px;
            overflow: visible;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .data-table .overflow-x-auto {
            overflow-x: auto;
            overflow-y: visible;
            max-height: calc(100vh - 400px);
            position: relative;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
        }
        
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table thead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -2px;
            height: 2px;
            background: #e2e8f0;
        }
        
        .data-table th {
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-size: 0.625rem;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
            background: #f8fafc;
        }
        
        .data-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            color: #1e293b;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        
        .data-table tbody tr {
            transition: background 0.2s ease;
        }
        
        .data-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .data-table tbody tr.weekend-row {
            background: #fef3c7;
        }
        
        .data-table tbody tr.weekend-row:hover {
            background: #fde68a;
        }
        
        .data-table tbody tr.today-row {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            font-weight: 600;
            position: relative;
        }
        
        .data-table tbody tr.today-row:hover {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        }
        
        .data-table tbody tr.today-row td {
            border-bottom: 2px solid #3b82f6;
        }
        
        .today-indicator {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            padding: 0.125rem 0.375rem;
            border-radius: 9999px;
            margin-left: 0.5rem;
            letter-spacing: 0.05em;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .8;
            }
        }
        
        .data-table tbody tr.future-row {
            background: #f1f5f9;
            opacity: 0.6;
        }
        
        .data-table tbody tr.bucket-row {
            background: #f8fafc;
            font-size: 0.813rem;
            display: none;
        }
        
        .data-table tbody tr.bucket-row.show {
            display: table-row;
        }
        
        .data-table tbody tr.bucket-row td:first-child {
            padding-left: 3rem;
        }
        
        .data-table tbody tr.has-buckets {
            cursor: pointer;
        }
        
        .data-table tbody tr.has-buckets:hover {
            background: #f1f5f9;
        }
        
        /* Bucket Badge Styling */
        .bucket-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }
        
        /* State-based bucket colors */
        .bucket-california {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
        }
        
        .bucket-arizona {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
        }
        
        .bucket-georgia {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #14532d;
        }
        
        .bucket-texas {
            background: linear-gradient(135deg, #fef08a, #fde047);
            color: #713f12;
        }
        
        /* Type-based bucket colors */
        .bucket-lsa {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            color: #581c87;
        }
        
        .bucket-brand {
            background: linear-gradient(135deg, #fef3c7, #fed7aa);
            color: #92400e;
        }
        
        .bucket-prospecting {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: #3730a3;
        }
        
        .bucket-youtube {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
        }
        
        .bucket-default {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #374151;
        }
        
        /* Total Row Styling */
        .data-table tbody tr.total-row {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-weight: 700;
            border-top: 3px solid #667eea;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .data-table tbody tr.total-row td {
            padding: 1rem 0.5rem;
            border-bottom: none;
            color: #1e293b;
            font-size: 0.9375rem;
        }
        
        .data-table tbody tr.total-row:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
        }
        
        /* Date Display */
        .date-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .date-num {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .date-day {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Chevron */
        .chevron {
            color: #94a3b8;
            transition: transform 0.2s ease;
            font-size: 0.75rem;
        }
        
        .chevron.rotated {
            transform: rotate(90deg);
        }
        
        /* Deltas */
        .metric-value-main {
            font-weight: 600;
        }
        
        .metric-delta {
            font-size: 0.625rem;
            margin-top: 0.125rem;
        }
        
        .metric-delta.positive {
            color: #10b981;
        }
        
        .metric-delta.negative {
            color: #ef4444;
        }
        
        .metric-delta.neutral {
            color: #64748b;
        }
        
        /* Text Colors */
        .text-cost {
            color: #dc2626;
        }
        
        .text-leads {
            color: #059669;
        }
        
        .text-conversion {
            color: #7c3aed;
        }
        
        /* Warning Metrics */
        .warning-metric {
            border-color: #fbbf24;
            background: #fffbeb;
        }
        
        /* Status Indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .status-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .status-indicator.error {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .loading-message {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 1.5rem;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .loading-details {
            margin-top: 1.5rem;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 0.75rem;
        }
        
        .loading-step {
            display: flex;
            align-items: center;
            padding: 0.375rem 0.5rem;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .loading-step i {
            margin-right: 0.5rem;
            width: 14px;
            text-align: center;
        }
        
        .loading-step.active {
            color: #667eea;
            font-weight: 500;
        }
        
        .loading-step.completed {
            color: #10b981;
        }
        
        .loading-step.completed i::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        .loading-step.error {
            color: #ef4444;
        }
        
        .loading-step.error i::before {
            content: '\f057';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .metric-card {
                padding: 0.75rem;
            }
            
            .metric-value {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-title">Loading Dashboard</div>
            <div class="loading-message" id="loading-message">Connecting to data sources...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="loading-details" id="loading-details">
                <div class="loading-step" id="step-1">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>Initializing connections...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 z-40">
        <div class="p-6 border-b border-gray-200 dark-mode:border-gray-700">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-lg flex items-center justify-center">
                    <span class="font-bold text-white text-sm">SJ</span>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 dark-mode:text-white">Sweet James</h1>
                    <p class="text-xs text-gray-500 dark-mode:text-gray-300">Analytics Suite</p>
                </div>
            </div>
        </div>
        
        <nav class="p-6 space-y-6">
            <!-- Navigation Section -->
            <div>
                <h3 class="text-xs font-medium text-gray-500 dark-mode:text-gray-400 uppercase tracking-wider mb-3">Dashboards</h3>
                <nav class="space-y-1">
                    <a href="/" class="nav-link">
                        <i class="fas fa-chart-line mr-3 w-4"></i>
                        <span>Daily PPC Dashboard</span>
                    </a>
                    <!-- <a href="/forecasting" class="nav-link">
                        <i class="fas fa-chart-bar mr-3 w-4"></i>
                        <span>Forecasting</span>
                    </a>
                    <a href="/comparison-dashboard" class="nav-link">
                        <i class="fas fa-balance-scale mr-3 w-4"></i>
                        <span>Period Comparison</span>
                    </a> -->
                    <a href="/current-month-performance" class="nav-link active">
                        <i class="fas fa-calendar-day mr-3 w-4"></i>
                        <span>Current Month</span>
                    </a>
                    <a href="/annual-analytics" class="nav-link">
                        <i class="fas fa-calendar mr-3 w-4"></i>
                        <span>Annual Analytics</span>
                    </a>
                </nav>
            </div>
        </nav>
        
        <div class="px-6 pb-6 space-y-4">
            <!-- API Status -->
            <div class="pt-4 border-t border-gray-200 dark-mode:border-gray-700">
                <h3 class="text-xs font-semibold uppercase text-gray-500 dark-mode:text-gray-400 mb-3">Connection Status</h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark-mode:bg-gray-800 rounded">
                        <span class="text-sm text-gray-700 dark-mode:text-gray-300">Google Ads</span>
                        <span id="google-status" class="status-indicator connected"></span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark-mode:bg-gray-800 rounded">
                        <span class="text-sm text-gray-700 dark-mode:text-gray-300">Salesforce</span>
                        <span id="salesforce-status" class="status-indicator connected"></span>
                    </div>
                </div>
            </div>
            
            <!-- Data Info -->
            <div>
                <h3 class="text-xs font-semibold uppercase text-gray-500 dark-mode:text-gray-400 mb-3">Data Source</h3>
                <div class="p-3 bg-gray-50 dark-mode:bg-gray-800 rounded-md">
                    <div class="text-sm font-medium text-gray-700 dark-mode:text-gray-300" id="data-source">Connecting...</div>
                    <div class="text-xs text-gray-500 dark-mode:text-gray-400 mt-1">
                        Last Updated: <span id="last-updated">--</span>
                    </div>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <i id="sidebarIcon" class="fas fa-chevron-left text-gray-500 text-sm"></i>
    </div>
    
    <!-- Main Content -->
    <main id="mainContent" class="main-content">
        <!-- Header -->
        <header class="card border-b sticky top-0 z-30">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Current Month Performance</h2>
                        <p class="text-sm text-gray-500 mt-1" id="month-label"></p>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div class="view-toggle">
                            <button id="btn-table" class="active" onclick="changeView('table')">
                                <i class="fas fa-table mr-2"></i>Table
                            </button>
                            <button id="btn-charts" onclick="changeView('charts')">
                                <i class="fas fa-chart-line mr-2"></i>Charts
                            </button>
                        </div>
                        
                        <button class="btn-secondary" onclick="exportToCSV()">
                            <i class="fas fa-download mr-2"></i>Export CSV
                        </button>
                        
                        <button class="btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex items-center gap-3 mt-4">
                    <!-- State Filter -->
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-700">State:</span>
                        <button class="state-filter-btn active" data-state="all" onclick="filterByState('all')">All</button>
                        <button class="state-filter-btn" data-state="CA" onclick="filterByState('CA')">CA</button>
                        <button class="state-filter-btn" data-state="AZ" onclick="filterByState('AZ')">AZ</button>
                        <button class="state-filter-btn" data-state="GA" onclick="filterByState('GA')">GA</button>
                        <button class="state-filter-btn" data-state="TX" onclick="filterByState('TX')">TX</button>
                    </div>
                    
                    <div class="border-l border-gray-300 h-8 mx-2"></div>
                    
                    <select id="bucket-filter" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="filterBuckets()">
                        <option value="all">All Buckets Combined</option>
                        <option value="breakdown" selected>Show Bucket Breakdown</option>
                    </select>
                    
                    <button id="expand-all" class="btn-secondary text-sm" onclick="expandAll()">
                        <i class="fas fa-expand-alt mr-2"></i>Expand All
                    </button>
                    
                    <button id="collapse-all" class="btn-secondary text-sm" onclick="collapseAll()">
                        <i class="fas fa-compress-alt mr-2"></i>Collapse All
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Content Area -->
        <div class="p-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6" id="summary-cards">
                <!-- Populated by JS -->
            </div>
            
            <!-- Table View -->
            <div id="table-view" class="data-table">
                <div class="overflow-x-auto" style="max-height: calc(100vh - 400px); overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 90px">Date</th>
                                <th>Ad Spend</th>
                                <th>Leads</th>
                                <th>% In Practice</th>
                                <th># In Practice</th>
                                <th>% Unqualified</th>
                                <th># Unqualified</th>
                                <th>CPL</th>
                                <th>Cases</th>
                                <th>CPA</th>
                                <th>Retainers</th>
                                <th>CPR</th>
                                <th>Conv %</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Charts View -->
            <div id="charts-view" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Spend & Leads</h3>
                        <div class="chart-container">
                            <canvas id="chart-spend-leads"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Cost Metrics</h3>
                        <div class="chart-container">
                            <canvas id="chart-costs"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Conversion Funnel</h3>
                        <div class="chart-container">
                            <canvas id="chart-funnel"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Bucket Performance</h3>
                        <div class="chart-container">
                            <canvas id="chart-buckets"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
    // Global variables
    let monthData = {};
    let currentView = 'table';
    let currentFilter = 'breakdown';
    let currentStateFilter = 'all';
    let chartInstances = {};
    
    // Initialize
    $(document).ready(function() {
        const now = new Date();
        const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        $('#month-label').text(monthName);
        
        // Setup sidebar toggle
        $('#sidebarToggle').click(function() {
            $('#sidebar').toggleClass('collapsed');
            $('#mainContent').toggleClass('expanded');
            $('#sidebarIcon').toggleClass('fa-chevron-left fa-chevron-right');
        });
        
        loadData();
    });
    
    // Show/Hide Loading
    function showLoader() {
        $('#loading-overlay').fadeIn(300);
    }
    
    function hideLoader() {
        $('#loading-overlay').fadeOut(300);
    }
    
    function updateLoader(progress, title, message) {
        $('#progress-fill').css('width', progress + '%');
        if (title) $('.loading-title').text(title);
        if (message) $('#loading-message').text(message);
    }
    
    // Format functions
    function formatCurrency(value) {
        if (value === null || value === undefined) return '$0';
        return '$' + Math.round(value).toLocaleString();
    }
    
    function formatNumber(value) {
        if (value === null || value === undefined) return '0';
        return Math.round(value).toLocaleString();
    }
    
    function formatPercent(value) {
        if (value === null || value === undefined || value === 0) return '0%';
        return (value * 100).toFixed(1) + '%';
    }
    
    function formatDelta(value, isCount = false) {
        if (value === null || value === undefined) return '';
        const prefix = value > 0 ? '+' : '';
        if (isCount) {
            return prefix + Math.round(value);
        }
        return prefix + formatCurrency(Math.abs(value)).replace('$', (value < 0 ? '-$' : '$'));
    }
    
    function getDeltaClass(value, isReverse = false) {
        if (value === null || value === undefined || value === 0) return 'neutral';
        if (isReverse) {
            return value > 0 ? 'negative' : 'positive';
        }
        return value > 0 ? 'positive' : 'negative';
    }
    
    // Get state from bucket name
    function getStateFromBucket(bucketName) {
        if (!bucketName) return null;
        if (bucketName.includes('California') || bucketName.includes('CA')) return 'CA';
        if (bucketName.includes('Arizona') || bucketName.includes('AZ')) return 'AZ';
        if (bucketName.includes('Georgia') || bucketName.includes('GA')) return 'GA';
        if (bucketName.includes('Texas') || bucketName.includes('TX')) return 'TX';
        return null;
    }
    
    // Get bucket color class based on bucket name
    function getBucketColorClass(bucketName) {
        if (!bucketName) return '';
        const nameLower = bucketName.toLowerCase();
        
        // State-based colors
        if (nameLower.includes('california') || nameLower.includes(' ca ')) {
            return 'bucket-california';
        } else if (nameLower.includes('arizona') || nameLower.includes(' az ')) {
            return 'bucket-arizona';
        } else if (nameLower.includes('georgia') || nameLower.includes(' ga ')) {
            return 'bucket-georgia';
        } else if (nameLower.includes('texas') || nameLower.includes(' tx ')) {
            return 'bucket-texas';
        }
        
        // Type-based colors
        if (nameLower.includes('lsa')) {
            return 'bucket-lsa';
        } else if (nameLower.includes('brand')) {
            return 'bucket-brand';
        } else if (nameLower.includes('prospecting')) {
            return 'bucket-prospecting';
        } else if (nameLower.includes('youtube') || nameLower.includes('crisp')) {
            return 'bucket-youtube';
        }
        
        // Default
        return 'bucket-default';
    }
    
    // Filter by state
    function filterByState(state) {
        currentStateFilter = state;
        
        $('.state-filter-btn').removeClass('active');
        $(`.state-filter-btn[data-state="${state}"]`).addClass('active');
        
        updateBucketFilter();
        updateSummaryCards();
        renderTable();
        
        if (currentView === 'charts') {
            renderCharts();
        }
    }
    
    // Load data with detailed progress updates
    async function loadData() {
        try {
            showLoader();
            const loadingSteps = $('#loading-details');
            loadingSteps.empty();
            
            // Step 1: Initialize
            addLoadingStep('Initializing connections...', 'active');
            updateLoader(5, 'Preparing Dashboard', 'Setting up data connections');
            await simulateDelay(300);
            completeLoadingStep(0);
            
            // Step 2: Connect to Google Ads
            addLoadingStep('Connecting to Google Ads API...', 'active');
            updateLoader(10, 'Google Ads Connection', 'Authenticating with Google Ads');
            await simulateDelay(400);
            completeLoadingStep(1);
            
            // Step 3: Connect to Salesforce
            addLoadingStep('Connecting to Salesforce/Litify...', 'active');
            updateLoader(15, 'Salesforce Connection', 'Establishing Litify connection');
            await simulateDelay(400);
            completeLoadingStep(2);
            
            // Step 4: Fetch campaign data
            addLoadingStep('Fetching campaign performance data...', 'active');
            updateLoader(20, 'Retrieving Campaigns', 'Loading Google Ads campaigns');
            
            // Step 5: Fetch current month data
            addLoadingStep('Processing current month data...', 'active');
            updateLoader(25, 'Fetching Monthly Data', 'Retrieving campaign performance');
            
            const response = await fetch('/api/current-month-daily');
            
            completeLoadingStep(3);
            completeLoadingStep(4);
            
            // Step 6: Parse data
            addLoadingStep('Parsing response data...', 'active');
            updateLoader(40, 'Processing Data', 'Analyzing campaign metrics');
            const data = await response.json();
            await simulateDelay(200);
            completeLoadingStep(5);
            
            // Step 7: Process daily metrics
            const totalDays = data.daily_data ? data.daily_data.length : 0;
            if (totalDays > 0) {
                addLoadingStep(`Processing ${totalDays} days of data...`, 'active');
                updateLoader(50, 'Daily Metrics', `Calculating metrics for ${totalDays} days`);
                await simulateDelay(300);
                completeLoadingStep(6);
                
                // Step 8: Calculate bucket performance
                addLoadingStep('Calculating bucket performance...', 'active');
                updateLoader(60, 'Bucket Analysis', 'Analyzing performance by bucket');
                await simulateDelay(200);
                completeLoadingStep(7);
                
                // Step 9: Process lead data
                addLoadingStep('Processing lead conversion data...', 'active');
                updateLoader(70, 'Lead Analysis', 'Calculating conversion rates');
                await simulateDelay(200);
                completeLoadingStep(8);
            }
            
            monthData = data;
            console.log('Raw API Response:', data);
            
            // Step 10: Build UI components
            addLoadingStep('Building summary cards...', 'active');
            updateLoader(80, 'Rendering UI', 'Creating summary metrics');
            updateSummaryCards();
            await simulateDelay(150);
            completeLoadingStep(totalDays > 0 ? 9 : 6);
            
            // Step 11: Build table
            addLoadingStep('Rendering performance table...', 'active');
            updateLoader(85, 'Building Table', 'Creating daily breakdown');
            updateBucketFilter();
            renderTable();
            await simulateDelay(150);
            completeLoadingStep(totalDays > 0 ? 10 : 7);
            
            // Step 12: Prepare charts
            addLoadingStep('Preparing visualization charts...', 'active');
            updateLoader(90, 'Chart Preparation', 'Setting up data visualizations');
            if (currentView === 'charts') {
                renderCharts();
            }
            await simulateDelay(150);
            completeLoadingStep(totalDays > 0 ? 11 : 8);
            
            // Step 13: Finalize
            addLoadingStep('Finalizing dashboard...', 'active');
            updateLoader(95, 'Almost Ready', 'Applying final touches');
            updateStatus();
            await simulateDelay(200);
            completeLoadingStep(totalDays > 0 ? 12 : 9);
            
            updateLoader(100, 'Complete!', 'Dashboard ready');
            
            // Add completion message
            addLoadingStep('✨ Dashboard loaded successfully!', 'completed');
            
            setTimeout(() => {
                hideLoader();
            }, 500);
            
        } catch (error) {
            console.error('Error:', error);
            
            // Show error in loading steps
            addLoadingStep(`❌ Error: ${error.message}`, 'error');
            updateLoader(0, 'Error loading data', error.message);
            
            setTimeout(() => {
                hideLoader();
                alert('Failed to load data: ' + error.message);
            }, 2000);
        }
    }
    
    // Helper functions for loading steps
    function addLoadingStep(text, status = '') {
        const step = $('<div class="loading-step ' + status + '">' +
            '<i class="fas fa-circle-notch fa-spin"></i>' +
            '<span>' + text + '</span>' +
        '</div>');
        $('#loading-details').append(step);
        
        // Auto-scroll to latest step
        const container = $('#loading-details');
        container.scrollTop(container[0].scrollHeight);
    }
    
    function completeLoadingStep(index) {
        const steps = $('#loading-details .loading-step');
        if (steps.length > index) {
            $(steps[index]).removeClass('active').addClass('completed');
            $(steps[index]).find('i').removeClass('fa-circle-notch fa-spin');
        }
    }
    
    function simulateDelay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Update summary cards with filtering (EXCLUDING Crisp/Youtube from main totals, but showing YouTube separately)
    function updateSummaryCards() {
        const dailyData = monthData.daily_data || [];
        const selectedBucket = $('#bucket-filter').val();
        
        const totals = {
            spend: 0,
            leads: 0,
            cases: 0,
            retainers: 0,
            inPractice: 0,
            unqualified: 0
        };
        
        // Separate totals for Crisp/Youtube
        const youtubeTotals = {
            spend: 0,
            leads: 0,
            cases: 0,
            retainers: 0,
            inPractice: 0,
            unqualified: 0
        };
        
        // Calculate totals based on current filters
        dailyData.forEach(day => {
            if (!day.isFuture && !day.is_future) {
                // Get main totals excluding Crisp/Youtube
                let dayData = calculateDayData(day, selectedBucket, currentStateFilter, true);
                
                totals.spend += dayData.spend;
                totals.leads += dayData.leads;
                totals.cases += dayData.cases;
                totals.retainers += dayData.retainers;
                totals.inPractice += dayData.inPractice;
                totals.unqualified += dayData.unqualified;
                
                // Calculate Crisp/Youtube separately if showing all buckets
                if ((selectedBucket === 'all' || selectedBucket === 'breakdown') && currentStateFilter === 'all' && day.buckets) {
                    day.buckets.forEach(bucket => {
                        if (bucket.name.includes('Youtube') || bucket.name.includes('Crisp')) {
                            youtubeTotals.spend += bucket.spend || 0;
                            youtubeTotals.leads += bucket.leads || 0;
                            youtubeTotals.cases += bucket.cases || 0;
                            youtubeTotals.retainers += bucket.retainers || 0;
                            youtubeTotals.inPractice += bucket.inPractice || bucket.in_practice || 0;
                            youtubeTotals.unqualified += bucket.unqualified || 0;
                        }
                    });
                }
            }
        });
        
        const avgCpl = totals.leads > 0 ? totals.spend / totals.leads : 0;
        const avgCpa = totals.cases > 0 ? totals.spend / totals.cases : 0;
        const avgCpr = totals.retainers > 0 ? totals.spend / totals.retainers : 0;
        const convRate = totals.inPractice > 0 ? (totals.retainers / totals.inPractice) * 100 : 0;
        
        // Calculate YouTube metrics
        const ytCpl = youtubeTotals.leads > 0 ? youtubeTotals.spend / youtubeTotals.leads : 0;
        const ytConvRate = youtubeTotals.inPractice > 0 ? (youtubeTotals.retainers / youtubeTotals.inPractice) * 100 : 0;
        
        const filterLabel = currentStateFilter !== 'all' ? 
            `${currentStateFilter} State` : 
            (selectedBucket !== 'all' && selectedBucket !== 'breakdown' ? 
                selectedBucket : 'All Buckets');
        
        let cards = `
            <div class="metric-card">
                <div class="metric-label">Total Spend</div>
                <div class="metric-value text-cost">${formatCurrency(totals.spend)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${filterLabel} (excl. YouTube)
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">Total Leads</div>
                <div class="metric-value text-leads">${formatNumber(totals.leads)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${dailyData.length} days (excl. YouTube)
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">In Practice</div>
                <div class="metric-value">${formatNumber(totals.inPractice)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${totals.leads > 0 ? ((totals.inPractice / totals.leads) * 100).toFixed(1) + '% of leads' : ''}
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">Unqualified</div>
                <div class="metric-value">${formatNumber(totals.unqualified)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${totals.leads > 0 ? ((totals.unqualified / totals.leads) * 100).toFixed(1) + '% of leads' : ''}
                </div>
            </div>
            
            <div class="metric-card ${avgCpl > 1000 ? 'warning-metric' : ''}">
                <div class="metric-label">Avg CPL</div>
                <div class="metric-value text-cost">${formatCurrency(avgCpl)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${totals.leads > 0 ? 'Per lead (excl. YT)' : ''}
                </div>
            </div>
            
            <div class="metric-card ${avgCpa > 5000 ? 'warning-metric' : ''}">
                <div class="metric-label">Avg CPA</div>
                <div class="metric-value text-cost">${formatCurrency(avgCpa)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${totals.cases > 0 ? 'Per case (excl. YT)' : ''}
                </div>
            </div>
            
            <div class="metric-card ${convRate < 20 ? 'warning-metric' : ''}">
                <div class="metric-label">Conv Rate</div>
                <div class="metric-value">${formatPercent(totals.cases/totals.leads)}</div>
                <div class="metric-change text-gray-500 text-xs">
                    ${totals.cases > 0 ? totals.cases + ' cases' : ''}
                </div>
            </div>
        `;
        
        // Add YouTube card if there's data and we're showing all buckets
        if ((youtubeTotals.spend > 0 || youtubeTotals.leads > 0) && 
            currentStateFilter === 'all' && 
            (selectedBucket === 'all' || selectedBucket === 'breakdown')) {
            cards += `
                <div class="metric-card" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #dc2626;">
                    <div class="metric-label" style="color: #991b1b;">
                        <i class="fab fa-youtube" style="margin-right: 4px;"></i>CRISP/YOUTUBE
                    </div>
                    <div class="metric-value" style="color: #dc2626;">${formatCurrency(youtubeTotals.spend)}</div>
                    <div class="metric-change text-xs" style="color: #b91c1c;">
                        ${youtubeTotals.leads} leads | CPL: ${formatCurrency(ytCpl)} | Conv: ${formatPercent(ytConvRate / 100)}
                    </div>
                </div>
            `;
        }
        
        $('#summary-cards').html(cards);
    }
    
    // Calculate day data based on filters
    function calculateDayData(day, bucketFilter, stateFilter, excludeCrispYoutube = false) {
        let result = {
            spend: 0,
            leads: 0,
            cases: 0,
            retainers: 0,
            inPractice: 0,
            unqualified: 0,
            cpl: 0,
            cpa: 0,
            cpr: 0,
            convRate: 0
        };
        
        if (stateFilter === 'all') {
            // All states
            if (bucketFilter === 'all' || bucketFilter === 'breakdown') {
                // Use day totals, but exclude Crisp/Youtube if needed
                if (excludeCrispYoutube && day.buckets) {
                    // Calculate totals excluding Crisp/Youtube buckets
                    day.buckets.forEach(bucket => {
                        if (!bucket.name.includes('Youtube') && !bucket.name.includes('Crisp')) {
                            result.spend += bucket.spend || 0;
                            result.leads += bucket.leads || 0;
                            result.cases += bucket.cases || 0;
                            result.retainers += bucket.retainers || 0;
                            result.inPractice += bucket.inPractice || bucket.in_practice || 0;
                            // Calculate unqualified as in-practice minus retainers
                            result.unqualified += Math.max(0, (bucket.inPractice || bucket.in_practice || 0) - (bucket.retainers || 0));
                        }
                    });
                } else {
                    // Use day totals as-is
                    result.spend = day.spend || 0;
                    result.leads = day.leads || 0;
                    result.cases = day.cases || 0;
                    result.retainers = day.retainers || 0;
                    result.inPractice = day.inPractice || day.in_practice || 0;
                    // Calculate unqualified as in-practice minus retainers
                    result.unqualified = Math.max(0, result.inPractice - result.retainers);
                }
            } else {
                // Specific bucket
                if (day.buckets) {
                    const bucket = day.buckets.find(b => b.name === bucketFilter);
                    if (bucket && (!excludeCrispYoutube || (!bucket.name.includes('Youtube') && !bucket.name.includes('Crisp')))) {
                        result.spend = bucket.spend || 0;
                        result.leads = bucket.leads || 0;
                        result.cases = bucket.cases || 0;
                        result.retainers = bucket.retainers || 0;
                        result.inPractice = bucket.inPractice || bucket.in_practice || 0;
                        // Calculate unqualified as in-practice minus retainers
                        result.unqualified = Math.max(0, result.inPractice - result.retainers);
                    }
                }
            }
        } else {
            // Specific state - aggregate buckets for that state
            if (day.buckets) {
                day.buckets.forEach(bucket => {
                    const bucketState = getStateFromBucket(bucket.name);
                    if (bucketState === stateFilter && (!excludeCrispYoutube || (!bucket.name.includes('Youtube') && !bucket.name.includes('Crisp')))) {
                        if (bucketFilter === 'all' || bucketFilter === 'breakdown' || bucket.name === bucketFilter) {
                            result.spend += bucket.spend || 0;
                            result.leads += bucket.leads || 0;
                            result.cases += bucket.cases || 0;
                            result.retainers += bucket.retainers || 0;
                            result.inPractice += bucket.inPractice || bucket.in_practice || 0;
                        }
                    }
                });
                // Calculate unqualified after aggregation
                result.unqualified = Math.max(0, result.inPractice - result.retainers);
            }
        }
        
        // Calculate derived metrics
        result.cpl = result.leads > 0 ? result.spend / result.leads : 0;
        result.cpa = result.cases > 0 ? result.spend / result.cases : 0;
        result.cpr = result.retainers > 0 ? result.spend / result.retainers : 0;
        result.convRate = result.leads > 0 ? (result.cases / result.leads) : 0;
        
        return result;
    }
    
    // Update bucket filter based on state
    function updateBucketFilter() {
        const buckets = monthData.available_buckets || [];
        const select = $('#bucket-filter');
        const currentValue = select.val();
        
        select.find('option:gt(1)').remove();
        
        if (currentStateFilter !== 'all') {
            // Filter buckets by state
            buckets.forEach(bucket => {
                const bucketState = getStateFromBucket(bucket);
                if (bucketState === currentStateFilter) {
                    select.append(`<option value="${bucket}">${bucket}</option>`);
                }
            });
        } else {
            // Show all buckets
            buckets.forEach(bucket => {
                select.append(`<option value="${bucket}">${bucket}</option>`);
            });
        }
        
        // Restore previous value if it exists
        if (select.find(`option[value="${currentValue}"]`).length) {
            select.val(currentValue);
        }
    }
    
    // Render table with filtering and totals
    function renderTable() {
        const tbody = $('#table-body');
        tbody.empty();
        
        const dailyData = monthData.daily_data || [];
        const selectedBucket = $('#bucket-filter').val();
        
        if (dailyData.length === 0) {
            tbody.append('<tr><td colspan="13" class="text-center py-8 text-gray-500">No data available</td></tr>');
            return;
        }
        
        // Variables for totals row (EXCLUDING Crisp/Youtube)
        const columnTotals = {
            spend: 0,
            leads: 0,
            inPractice: 0,
            unqualified: 0,
            cases: 0,
            retainers: 0
        };
        
        // Variables for Crisp/Youtube totals
        const crispYoutubeTotals = {
            spend: 0,
            leads: 0,
            inPractice: 0,
            unqualified: 0,
            cases: 0,
            retainers: 0
        };
        
        let todayRowIndex = -1;
        const today = new Date();
        const todayDay = today.getDate();
        
        // Render each day
        dailyData.forEach((day, index) => {
            const isFuture = day.isFuture || day.is_future;
            const isWeekend = day.isWeekend || day.is_weekend;
            const hasBuckets = day.buckets && day.buckets.length > 0;
            
            // Check if this is today's row
            const dayNum = day.dayNum || day.day_num || index + 1;
            const isToday = !isFuture && dayNum === todayDay;
            if (isToday) {
                todayRowIndex = index;
            }
            
            // Calculate day data based on filters
            const dayData = calculateDayData(day, selectedBucket, currentStateFilter);
            
            // Only add to totals if not a future day
            if (!isFuture) {
                // Calculate separate totals excluding Crisp/Youtube
                const dayDataExcludingYoutube = calculateDayData(day, selectedBucket, currentStateFilter, true);
                columnTotals.spend += dayDataExcludingYoutube.spend;
                columnTotals.leads += dayDataExcludingYoutube.leads;
                columnTotals.inPractice += dayDataExcludingYoutube.inPractice;
                columnTotals.unqualified += dayDataExcludingYoutube.unqualified;
                columnTotals.cases += dayDataExcludingYoutube.cases;
                columnTotals.retainers += dayDataExcludingYoutube.retainers;
                
                // Track Crisp/Youtube separately if showing all buckets
                if ((selectedBucket === 'all' || selectedBucket === 'breakdown') && currentStateFilter === 'all' && day.buckets) {
                    day.buckets.forEach(bucket => {
                        if (bucket.name.includes('Youtube') || bucket.name.includes('Crisp')) {
                            crispYoutubeTotals.spend += bucket.spend || 0;
                            crispYoutubeTotals.leads += bucket.leads || 0;
                            crispYoutubeTotals.inPractice += bucket.inPractice || bucket.in_practice || 0;
                            crispYoutubeTotals.unqualified += bucket.unqualified || 0;
                            crispYoutubeTotals.cases += bucket.cases || 0;
                            crispYoutubeTotals.retainers += bucket.retainers || 0;
                        }
                    });
                }
            }
            
            const inPracticePct = dayData.leads > 0 ? (dayData.inPractice / dayData.leads) : 0;
            const unqualifiedPct = dayData.leads > 0 ? (dayData.unqualified / dayData.leads) : 0;
            
            let rowClass = '';
            if (isFuture) rowClass = 'future-row';
            else if (isToday) rowClass = 'today-row';
            else if (isWeekend) rowClass = 'weekend-row';
            if (hasBuckets && currentFilter === 'breakdown') rowClass += ' has-buckets';
            
            const dateDisplay = `
                <div class="date-cell">
                    ${hasBuckets && currentFilter === 'breakdown' ? 
                        '<i class="fas fa-chevron-right chevron"></i>' : 
                        '<span style="width: 14px; display: inline-block;"></span>'}
                    <div>
                        <div class="date-num">${dayNum}</div>
                        <div class="date-day">${day.dayName || day.day_name || ''}</div>
                    </div>
                    ${isToday ? '<span class="today-indicator">TODAY</span>' : ''}
                </div>
            `;
            
            const spendDelta = currentStateFilter === 'all' && selectedBucket === 'all' ? (day.spendDelta || day.spend_delta || null) : null;
            const leadsDelta = currentStateFilter === 'all' && selectedBucket === 'all' ? (day.leadsDelta || day.leads_delta || null) : null;
            
            const row = $(
                '<tr class="' + rowClass + '" data-index="' + index + '" id="row-' + index + '">' +
                    '<td>' + dateDisplay + '</td>' +
                    '<td>' +
                        '<div class="metric-value-main">' + formatCurrency(dayData.spend) + '</div>' +
                        (spendDelta !== null && spendDelta !== undefined ? 
                            '<div class="metric-delta ' + getDeltaClass(spendDelta, true) + '">' + formatDelta(spendDelta) + '</div>' : '') +
                    '</td>' +
                    '<td>' +
                        '<div class="metric-value-main">' + formatNumber(dayData.leads) + '</div>' +
                        (leadsDelta !== null && leadsDelta !== undefined ? 
                            '<div class="metric-delta ' + getDeltaClass(leadsDelta, false) + '">' + formatDelta(leadsDelta, true) + '</div>' : '') +
                    '</td>' +
                    '<td>' + formatPercent(inPracticePct) + '</td>' +
                    '<td>' + formatNumber(dayData.inPractice) + '</td>' +
                    '<td>' + formatPercent(unqualifiedPct) + '</td>' +
                    '<td>' + formatNumber(dayData.unqualified) + '</td>' +
                    '<td>' + formatCurrency(dayData.cpl) + '</td>' +
                    '<td>' + formatNumber(dayData.cases) + '</td>' +
                    '<td>' + formatCurrency(dayData.cpa) + '</td>' +
                    '<td>' + formatNumber(dayData.retainers) + '</td>' +
                    '<td>' + formatCurrency(dayData.cpr) + '</td>' +
                    '<td>' + formatPercent(dayData.convRate) + '</td>' +
                '</tr>'
            );
            
            tbody.append(row);
            
            // Add bucket rows if in breakdown mode
            if (hasBuckets && currentFilter === 'breakdown') {
                const bucketsToShow = currentStateFilter === 'all' ? 
                    day.buckets : 
                    day.buckets.filter(b => getStateFromBucket(b.name) === currentStateFilter);
                
                bucketsToShow.forEach(bucket => {
                    const bucketInPracticePct = bucket.leads > 0 ? (bucket.inPractice || bucket.in_practice || 0) / bucket.leads : 0;
                    const bucketUnqualifiedPct = bucket.leads > 0 ? (bucket.unqualified || 0) / bucket.leads : 0;
                    
                    // Get bucket color class
                    const bucketColorClass = getBucketColorClass(bucket.name);
                    
                    const bucketRow = $(
                        '<tr class="bucket-row" data-parent="' + index + '">' +
                            '<td style="padding-left: 3rem;"><span class="bucket-badge ' + bucketColorClass + '">' + bucket.name + '</span></td>' +
                            '<td>' + formatCurrency(bucket.spend) + '</td>' +
                            '<td>' + formatNumber(bucket.leads) + '</td>' +
                            '<td>' + formatPercent(bucketInPracticePct) + '</td>' +
                            '<td>' + formatNumber(bucket.inPractice || bucket.in_practice) + '</td>' +
                            '<td>' + formatPercent(bucketUnqualifiedPct) + '</td>' +
                            '<td>' + formatNumber(bucket.unqualified) + '</td>' +
                            '<td>' + formatCurrency(bucket.cpl) + '</td>' +
                            '<td>' + formatNumber(bucket.cases) + '</td>' +
                            '<td>' + formatCurrency(bucket.cpa) + '</td>' +
                            '<td>' + formatNumber(bucket.retainers) + '</td>' +
                            '<td>' + formatCurrency(bucket.cpr) + '</td>' +
                            '<td>' + formatPercent(bucket.convRate || bucket.conv_rate || 0) + '</td>' +
                        '</tr>'
                    );
                    
                    tbody.append(bucketRow);
                });
            }
        });
        
        // Add totals row (EXCLUDING Crisp/Youtube)
        const avgCpl = columnTotals.leads > 0 ? columnTotals.spend / columnTotals.leads : 0;
        const avgCpa = columnTotals.cases > 0 ? columnTotals.spend / columnTotals.cases : 0;
        const avgCpr = columnTotals.retainers > 0 ? columnTotals.spend / columnTotals.retainers : 0;
        const convRate = columnTotals.leads > 0 ? (columnTotals.cases / columnTotals.leads) : 0;
        const inPracticePct = columnTotals.leads > 0 ? (columnTotals.inPractice / columnTotals.leads) : 0;
        const unqualifiedPct = columnTotals.leads > 0 ? (columnTotals.unqualified / columnTotals.leads) : 0;
        
        const totalRow = $(
            '<tr class="total-row">' +
                '<td><strong>SUBTOTAL (excl. YouTube)</strong></td>' +
                '<td><strong>' + formatCurrency(columnTotals.spend) + '</strong></td>' +
                '<td><strong>' + formatNumber(columnTotals.leads) + '</strong></td>' +
                '<td><strong>' + formatPercent(inPracticePct) + '</strong></td>' +
                '<td><strong>' + formatNumber(columnTotals.inPractice) + '</strong></td>' +
                '<td><strong>' + formatPercent(unqualifiedPct) + '</strong></td>' +
                '<td><strong>' + formatNumber(columnTotals.unqualified) + '</strong></td>' +
                '<td><strong>' + formatCurrency(avgCpl) + '</strong></td>' +
                '<td><strong>' + formatNumber(columnTotals.cases) + '</strong></td>' +
                '<td><strong>' + formatCurrency(avgCpa) + '</strong></td>' +
                '<td><strong>' + formatNumber(columnTotals.retainers) + '</strong></td>' +
                '<td><strong>' + formatCurrency(avgCpr) + '</strong></td>' +
                '<td><strong>' + formatPercent(convRate) + '</strong></td>' +
            '</tr>'
        );
        
        tbody.append(totalRow);
        
        // Add Crisp/Youtube row if there's data
        if (crispYoutubeTotals.spend > 0 || crispYoutubeTotals.leads > 0) {
            const ytCpl = crispYoutubeTotals.leads > 0 ? crispYoutubeTotals.spend / crispYoutubeTotals.leads : 0;
            const ytCpa = crispYoutubeTotals.cases > 0 ? crispYoutubeTotals.spend / crispYoutubeTotals.cases : 0;
            const ytCpr = crispYoutubeTotals.retainers > 0 ? crispYoutubeTotals.spend / crispYoutubeTotals.retainers : 0;
            const ytConvRate = crispYoutubeTotals.inPractice > 0 ? (crispYoutubeTotals.retainers / crispYoutubeTotals.inPractice) : 0;
            const ytInPracticePct = crispYoutubeTotals.leads > 0 ? (crispYoutubeTotals.inPractice / crispYoutubeTotals.leads) : 0;
            const ytUnqualifiedPct = crispYoutubeTotals.leads > 0 ? (crispYoutubeTotals.unqualified / crispYoutubeTotals.leads) : 0;
            
            const youtubeRow = $(
                '<tr style="background: linear-gradient(135deg, #fee2e2, #fecaca); font-weight: 600;">' +
                    '<td><span class="bucket-badge bucket-youtube">Crisp/Youtube</span></td>' +
                    '<td>' + formatCurrency(crispYoutubeTotals.spend) + '</td>' +
                    '<td>' + formatNumber(crispYoutubeTotals.leads) + '</td>' +
                    '<td>' + formatPercent(ytInPracticePct) + '</td>' +
                    '<td>' + formatNumber(crispYoutubeTotals.inPractice) + '</td>' +
                    '<td>' + formatPercent(ytUnqualifiedPct) + '</td>' +
                    '<td>' + formatNumber(crispYoutubeTotals.unqualified) + '</td>' +
                    '<td>' + formatCurrency(ytCpl) + '</td>' +
                    '<td>' + formatNumber(crispYoutubeTotals.cases) + '</td>' +
                    '<td>' + formatCurrency(ytCpa) + '</td>' +
                    '<td>' + formatNumber(crispYoutubeTotals.retainers) + '</td>' +
                    '<td>' + formatCurrency(ytCpr) + '</td>' +
                    '<td>' + formatPercent(ytConvRate) + '</td>' +
                '</tr>'
            );
            
            tbody.append(youtubeRow);
        }
        
        // Add click handlers for expandable rows
        $('.has-buckets').off('click').on('click', function(e) {
            if (!$(e.target).closest('a').length) {
                const index = $(this).data('index');
                toggleBuckets(index);
            }
        });
        
        // Scroll to today's row if found
        if (todayRowIndex >= 0) {
            setTimeout(() => {
                const todayRow = $('#row-' + todayRowIndex);
                if (todayRow.length) {
                    const container = $('.data-table .overflow-x-auto');
                    const rowTop = todayRow.position().top;
                    const containerHeight = container.height();
                    const scrollPosition = rowTop - (containerHeight / 3); // Position today's row in upper third
                    
                    container.animate({
                        scrollTop: scrollPosition
                    }, 500, 'swing');
                }
            }, 100); // Small delay to ensure DOM is ready
        }
    }
    
    // Toggle bucket rows
    function toggleBuckets(index) {
        const bucketRows = $(`.bucket-row[data-parent="${index}"]`);
        const chevron = $(`.has-buckets[data-index="${index}"] .chevron, tr[data-index="${index}"] .chevron`);
        
        if (bucketRows.hasClass('show')) {
            bucketRows.removeClass('show');
            chevron.removeClass('rotated');
        } else {
            bucketRows.addClass('show');
            chevron.addClass('rotated');
        }
    }
    
    // Expand/Collapse all
    function expandAll() {
        $('.bucket-row').addClass('show');
        $('.chevron').addClass('rotated');
    }
    
    function collapseAll() {
        $('.bucket-row').removeClass('show');
        $('.chevron').removeClass('rotated');
    }
    
    // Filter buckets
    function filterBuckets() {
        currentFilter = $('#bucket-filter').val();
        updateSummaryCards();
        renderTable();
        
        if (currentFilter === 'breakdown') {
            $('#expand-all, #collapse-all').show();
        } else {
            $('#expand-all, #collapse-all').hide();
        }
        
        if (currentView === 'charts') {
            renderCharts();
        }
    }
    
    // Change view
    function changeView(view) {
        currentView = view;
        
        $('.view-toggle button').removeClass('active');
        $(`#btn-${view}`).addClass('active');
        
        if (view === 'table') {
            $('#table-view').show();
            $('#charts-view').hide();
        } else {
            $('#table-view').hide();
            $('#charts-view').show();
            renderCharts();
        }
    }
    
    // Update status
    function updateStatus() {
        const now = new Date();
        $('#last-updated').text(now.toLocaleTimeString());
        
        if (monthData.daily_data && monthData.daily_data.length > 0) {
            $('#google-status').removeClass('bg-amber-500').addClass('bg-green-500');
            $('#salesforce-status').removeClass('bg-amber-500').addClass('bg-green-500');
            $('#data-source').text('Live Data');
        } else {
            $('#data-source').text('No Data');
        }
    }
    
    // Render charts with filtering
    function renderCharts() {
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};
        
        const dailyData = monthData.daily_data || [];
        const selectedBucket = $('#bucket-filter').val();
        
        // Process data for charts based on filters
        const labels = [];
        const spendData = [];
        const leadsData = [];
        const cplData = [];
        const cpaData = [];
        const cprData = [];
        const funnelData = {
            leads: 0,
            inPractice: 0,
            cases: 0,
            retainers: 0
        };
        
        dailyData.forEach(day => {
            if (!day.isFuture && !day.is_future) {
                const dayData = calculateDayData(day, selectedBucket, currentStateFilter);
                
                labels.push(day.dayNum || day.day_num);
                spendData.push(dayData.spend);
                leadsData.push(dayData.leads);
                cplData.push(dayData.cpl);
                cpaData.push(dayData.cpa);
                cprData.push(dayData.cpr);
                
                funnelData.leads += dayData.leads;
                funnelData.inPractice += dayData.inPractice;
                funnelData.cases += dayData.cases;
                funnelData.retainers += dayData.retainers;
            }
        });
        
        // Spend & Leads Chart
        const ctx1 = document.getElementById('chart-spend-leads').getContext('2d');
        chartInstances.spendLeads = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Spend',
                    data: spendData,
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    yAxisID: 'y',
                }, {
                    label: 'Leads',
                    data: leadsData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    yAxisID: 'y1',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
        
        // Cost Metrics Chart
        const ctx2 = document.getElementById('chart-costs').getContext('2d');
        chartInstances.costs = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'CPL',
                    data: cplData,
                    borderColor: 'rgb(251, 191, 36)',
                    backgroundColor: 'rgba(251, 191, 36, 0.1)',
                }, {
                    label: 'CPA',
                    data: cpaData,
                    borderColor: 'rgb(168, 85, 247)',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                }, {
                    label: 'CPR',
                    data: cprData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
        // Funnel Chart
        const ctx3 = document.getElementById('chart-funnel').getContext('2d');
        chartInstances.funnel = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: ['Leads', 'In Practice', 'Cases', 'Retainers'],
                datasets: [{
                    label: 'Count',
                    data: [
                        funnelData.leads,
                        funnelData.inPractice,
                        funnelData.cases,
                        funnelData.retainers
                    ],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(168, 85, 247, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Bucket Performance Chart
        if (currentFilter === 'breakdown' && monthData.daily_data) {
            const bucketTotals = {};
            
            dailyData.forEach(day => {
                if (!day.isFuture && !day.is_future && day.buckets) {
                    day.buckets.forEach(bucket => {
                        const bucketState = getStateFromBucket(bucket.name);
                        if (currentStateFilter === 'all' || bucketState === currentStateFilter) {
                            if (!bucketTotals[bucket.name]) {
                                bucketTotals[bucket.name] = {
                                    spend: 0,
                                    leads: 0
                                };
                            }
                            bucketTotals[bucket.name].spend += bucket.spend || 0;
                            bucketTotals[bucket.name].leads += bucket.leads || 0;
                        }
                    });
                }
            });
            
            const bucketNames = Object.keys(bucketTotals);
            const bucketSpends = bucketNames.map(name => bucketTotals[name].spend);
            const bucketLeads = bucketNames.map(name => bucketTotals[name].leads);
            
            const ctx4 = document.getElementById('chart-buckets').getContext('2d');
            chartInstances.buckets = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: bucketNames,
                    datasets: [{
                        label: 'Spend',
                        data: bucketSpends,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        yAxisID: 'y',
                    }, {
                        label: 'Leads',
                        data: bucketLeads,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }
    }
    
    // Export to CSV
    function exportToCSV() {
        const dailyData = monthData.daily_data || [];
        const selectedBucket = $('#bucket-filter').val();
        let csvContent = 'Date,Day,Bucket,Spend,Leads,% In Practice,# In Practice,% Unqualified,# Unqualified,CPL,Cases,CPA,Retainers,CPR,Conv %\n';
        
        dailyData.forEach(day => {
            if (!day.isFuture && !day.is_future) {
                const date = day.date || '';
                const dayNum = day.dayNum || day.day_num || '';
                
                // Calculate day data based on filters
                const dayData = calculateDayData(day, selectedBucket, currentStateFilter);
                
                if (currentStateFilter === 'all' && selectedBucket === 'breakdown' && day.buckets) {
                    // Export all buckets
                    day.buckets.forEach(bucket => {
                        const bucketInPracticePct = bucket.leads > 0 ? 
                            ((bucket.inPractice || bucket.in_practice || 0) / bucket.leads * 100).toFixed(1) : '0';
                        const bucketUnqualifiedPct = bucket.leads > 0 ? 
                            ((bucket.unqualified || 0) / bucket.leads * 100).toFixed(1) : '0';
                        const bucketConvRate = (bucket.inPractice || bucket.in_practice || 0) > 0 ? 
    ((bucket.retainers || 0) / (bucket.inPractice || bucket.in_practice || 0)) : 0;
                        
                        csvContent += date + ',' + dayNum + ',' + bucket.name + ',' + 
                            Math.round(bucket.spend) + ',' + Math.round(bucket.leads) + ',' + 
                            bucketInPracticePct + ',' + Math.round(bucket.inPractice || bucket.in_practice || 0) + ',' + 
                            bucketUnqualifiedPct + ',' + Math.round(bucket.unqualified || 0) + ',' + 
                            Math.round(bucket.cpl || 0) + ',' + Math.round(bucket.cases || 0) + ',' + 
                            Math.round(bucket.cpa || 0) + ',' + Math.round(bucket.retainers || 0) + ',' + 
                            Math.round(bucket.cpr || 0) + ',' + bucketConvRate + '\n';
                    });
                } else {
                    // Export filtered data
                    const inPracticePct = dayData.leads > 0 ? 
                        (dayData.inPractice / dayData.leads * 100).toFixed(1) : '0';
                    // Keep these as-is (unqualified % should be of total leads, not in-practice)
                    const unqualifiedPct = dayData.leads > 0 ? (dayData.unqualified / dayData.leads) : 0;
                    const convRate = (dayData.convRate * 100).toFixed(2);
                    
                    const bucketName = selectedBucket === 'all' ? 'All Buckets' : 
                                     selectedBucket === 'breakdown' ? 'Daily Total' : selectedBucket;
                    
                    csvContent += date + ',' + dayNum + ',' + bucketName + ',' + 
                        Math.round(dayData.spend) + ',' + Math.round(dayData.leads) + ',' + 
                        inPracticePct + ',' + Math.round(dayData.inPractice) + ',' + 
                        unqualifiedPct + ',' + Math.round(dayData.unqualified) + ',' + 
                        Math.round(dayData.cpl) + ',' + Math.round(dayData.cases) + ',' + 
                        Math.round(dayData.cpa) + ',' + Math.round(dayData.retainers) + ',' + 
                        Math.round(dayData.cpr) + ',' + convRate + '\n';
                }
            }
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'current-month-performance-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }
    
    // Refresh data
    function refreshData() {
        loadData();
    }
    </script>
</body>
</html>